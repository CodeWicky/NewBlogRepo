<!doctype html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="RunLoop," />








  <link rel="shortcut icon" type="image/x-icon" href="/Favicon.ico?v=5.1.1" />






<meta name="description" content="ä¸å¾—ä¸è¯´ï¼Œäººçš„æƒ°æ€§æ˜¯çœŸå¯æ€•å•Šã€‚ä»ä¸Šå‘¨å…­å°±åˆ°å†™runLoopçš„å»ºè®®å¼€å§‹ï¼Œæ˜ŸæœŸä¸‰å‘Šè¯‰è‡ªå·±ä»æ˜ŸæœŸå››å¼€å§‹ç€æ‰‹å†™è¿™ç¯‡åšå®¢ã€‚ç„¶è€Œç°åœ¨æˆ³ä¸ªæ—¶é—´æˆ³ï¼Œç°åœ¨æ˜¯4.30æ˜ŸæœŸæ—¥ã€‚å†™å®Œå‘å‡ºå»åˆä¸çŸ¥é“æ˜¯ä»€ä¹ˆæ—¶å€™å•¦ï¼Œå“ˆå“ˆå“ˆğŸ˜  è¿™ä¸€æœŸè®²ä»€ä¹ˆå‘¢ï¼Ÿè¿™ä¸€æœŸè®²runLoopå“Ÿã€‚ä¸€ç›´ä»¥æ¥ï¼ŒrunLoopè¿™ä¸ªç„è€Œåˆç„çš„ä¸œè¥¿ä¼¼ä¹è¢«å½“åšäº†å…¬å¸é¢è¯•æŒ‘äººçš„ç»ˆæè¯é¢˜ï¼ŒåŸå› ä¸éš¾æƒ³ï¼Œæ—¥å¸¸å¼€å‘ç”¨åˆ°runLoopçš„åœ°æ–¹å°‘ä¹‹åˆå°‘ï¼Œæ²¡æœ‰æ—¶é—´çš„ç§¯ç´¯è¿™æ–¹é¢çš„çŸ¥">
<meta name="keywords" content="RunLoop">
<meta property="og:type" content="article">
<meta property="og:title" content="è€å¸æœºå‡ºå“â€”â€”æºç è§£æä¹‹RunLoopè¯¦è§£">
<meta property="og:url" content="http://codewicky.coding.me/2017/05/02/è€å¸æœºå‡ºå“â€”â€”æºç è§£æä¹‹RunLoopè¯¦è§£/index.html">
<meta property="og:site_name" content="R &amp; W">
<meta property="og:description" content="ä¸å¾—ä¸è¯´ï¼Œäººçš„æƒ°æ€§æ˜¯çœŸå¯æ€•å•Šã€‚ä»ä¸Šå‘¨å…­å°±åˆ°å†™runLoopçš„å»ºè®®å¼€å§‹ï¼Œæ˜ŸæœŸä¸‰å‘Šè¯‰è‡ªå·±ä»æ˜ŸæœŸå››å¼€å§‹ç€æ‰‹å†™è¿™ç¯‡åšå®¢ã€‚ç„¶è€Œç°åœ¨æˆ³ä¸ªæ—¶é—´æˆ³ï¼Œç°åœ¨æ˜¯4.30æ˜ŸæœŸæ—¥ã€‚å†™å®Œå‘å‡ºå»åˆä¸çŸ¥é“æ˜¯ä»€ä¹ˆæ—¶å€™å•¦ï¼Œå“ˆå“ˆå“ˆğŸ˜  è¿™ä¸€æœŸè®²ä»€ä¹ˆå‘¢ï¼Ÿè¿™ä¸€æœŸè®²runLoopå“Ÿã€‚ä¸€ç›´ä»¥æ¥ï¼ŒrunLoopè¿™ä¸ªç„è€Œåˆç„çš„ä¸œè¥¿ä¼¼ä¹è¢«å½“åšäº†å…¬å¸é¢è¯•æŒ‘äººçš„ç»ˆæè¯é¢˜ï¼ŒåŸå› ä¸éš¾æƒ³ï¼Œæ—¥å¸¸å¼€å‘ç”¨åˆ°runLoopçš„åœ°æ–¹å°‘ä¹‹åˆå°‘ï¼Œæ²¡æœ‰æ—¶é—´çš„ç§¯ç´¯è¿™æ–¹é¢çš„çŸ¥">
<meta property="og:image" content="http://upload-images.jianshu.io/upload_images/1835430-cccdcd8278846522.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:image" content="http://upload-images.jianshu.io/upload_images/1835430-eb798302dcb50708.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:image" content="http://upload-images.jianshu.io/upload_images/1835430-9f5079fdc39bf56f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:image" content="http://upload-images.jianshu.io/upload_images/1835430-a84a8802abc125cb.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:image" content="http://upload-images.jianshu.io/upload_images/1835430-1a9ffd190ef7c73b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:image" content="http://upload-images.jianshu.io/upload_images/1835430-c01c74630903d263.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:image" content="http://upload-images.jianshu.io/upload_images/1835430-96b2100c0f20d96a.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:image" content="http://upload-images.jianshu.io/upload_images/1835430-bc004dc959f7b675.gif?imageMogr2/auto-orient/strip">
<meta property="og:image" content="http://upload-images.jianshu.io/upload_images/1835430-456beaed3f710b02.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:image" content="http://upload-images.jianshu.io/upload_images/1835430-e7706ffe827b1ea1.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:updated_time" content="2017-06-04T23:33:44.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="è€å¸æœºå‡ºå“â€”â€”æºç è§£æä¹‹RunLoopè¯¦è§£">
<meta name="twitter:description" content="ä¸å¾—ä¸è¯´ï¼Œäººçš„æƒ°æ€§æ˜¯çœŸå¯æ€•å•Šã€‚ä»ä¸Šå‘¨å…­å°±åˆ°å†™runLoopçš„å»ºè®®å¼€å§‹ï¼Œæ˜ŸæœŸä¸‰å‘Šè¯‰è‡ªå·±ä»æ˜ŸæœŸå››å¼€å§‹ç€æ‰‹å†™è¿™ç¯‡åšå®¢ã€‚ç„¶è€Œç°åœ¨æˆ³ä¸ªæ—¶é—´æˆ³ï¼Œç°åœ¨æ˜¯4.30æ˜ŸæœŸæ—¥ã€‚å†™å®Œå‘å‡ºå»åˆä¸çŸ¥é“æ˜¯ä»€ä¹ˆæ—¶å€™å•¦ï¼Œå“ˆå“ˆå“ˆğŸ˜  è¿™ä¸€æœŸè®²ä»€ä¹ˆå‘¢ï¼Ÿè¿™ä¸€æœŸè®²runLoopå“Ÿã€‚ä¸€ç›´ä»¥æ¥ï¼ŒrunLoopè¿™ä¸ªç„è€Œåˆç„çš„ä¸œè¥¿ä¼¼ä¹è¢«å½“åšäº†å…¬å¸é¢è¯•æŒ‘äººçš„ç»ˆæè¯é¢˜ï¼ŒåŸå› ä¸éš¾æƒ³ï¼Œæ—¥å¸¸å¼€å‘ç”¨åˆ°runLoopçš„åœ°æ–¹å°‘ä¹‹åˆå°‘ï¼Œæ²¡æœ‰æ—¶é—´çš„ç§¯ç´¯è¿™æ–¹é¢çš„çŸ¥">
<meta name="twitter:image" content="http://upload-images.jianshu.io/upload_images/1835430-cccdcd8278846522.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":true},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: 'åšä¸»'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://codewicky.coding.me/2017/05/02/è€å¸æœºå‡ºå“â€”â€”æºç è§£æä¹‹RunLoopè¯¦è§£/"/>





  <title>è€å¸æœºå‡ºå“â€”â€”æºç è§£æä¹‹RunLoopè¯¦è§£ | R & W</title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  















  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">R & W</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <h1 class="site-subtitle" itemprop="description">æ„¿å¾—ä»Šæœå›¾é¸¿å¿—ï¼Œä¸ä½œæ±Ÿéƒå¹æ¯å£°ã€‚</h1>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            é¦–é¡µ
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            åˆ†ç±»
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            å½’æ¡£
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            æ ‡ç­¾
          </a>
        </li>
      
        
        <li class="menu-item menu-item-messageboard">
          <a href="/messageBoard" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            ç•™è¨€æ¿
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://codewicky.coding.me/2017/05/02/è€å¸æœºå‡ºå“â€”â€”æºç è§£æä¹‹RunLoopè¯¦è§£/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="CodeWicky">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="R & W">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">è€å¸æœºå‡ºå“â€”â€”æºç è§£æä¹‹RunLoopè¯¦è§£</h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              
              <time title="åˆ›å»ºäº" itemprop="dateCreated datePublished" datetime="2017-05-02T07:33:44+08:00">
                2017-05-02
              </time>
            

            
              <span class="post-meta-divider">|</span>
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">æ›´æ–°äº</span>
              
              <time title="æ›´æ–°äº" itemprop="dateModified" datetime="2017-06-05T07:33:44+08:00">
                2017-06-05
              </time>
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">åˆ†ç±»äº</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/æºç è§£æ/" itemprop="url" rel="index">
                    <span itemprop="name">æºç è§£æ</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
              <span class="post-meta-divider">|</span>
              <span class="post-meta-item-icon">
                <i class="fa fa-comment-o"></i>
              </span>
              
                  <span class="post-meta-item-text">è®¨è®º</span>
              
              
                <a href="/2017/05/02/è€å¸æœºå‡ºå“â€”â€”æºç è§£æä¹‹RunLoopè¯¦è§£/" itemprop="discussionUrl">
                  <span id="changyan_count_unit" class="post-comments-count hc-comment-count" data-xid="2017/05/02/è€å¸æœºå‡ºå“â€”â€”æºç è§£æä¹‹RunLoopè¯¦è§£/" itemprop="commentsCount"></span>
                </a>
              
            
          

          
          
             <span id="/2017/05/02/è€å¸æœºå‡ºå“â€”â€”æºç è§£æä¹‹RunLoopè¯¦è§£/" class="leancloud_visitors" data-flag-title="è€å¸æœºå‡ºå“â€”â€”æºç è§£æä¹‹RunLoopè¯¦è§£">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">é˜…è¯»æ¬¡æ•° </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        <p><img src="http://upload-images.jianshu.io/upload_images/1835430-cccdcd8278846522.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="RunLoopè¯¦è§£"></p>
<p>ä¸å¾—ä¸è¯´ï¼Œäººçš„<strong>æƒ°æ€§</strong>æ˜¯çœŸå¯æ€•å•Šã€‚<br>ä»ä¸Šå‘¨å…­å°±åˆ°å†™runLoopçš„å»ºè®®å¼€å§‹ï¼Œæ˜ŸæœŸä¸‰å‘Šè¯‰è‡ªå·±ä»æ˜ŸæœŸå››å¼€å§‹ç€æ‰‹å†™è¿™ç¯‡åšå®¢ã€‚ç„¶è€Œç°åœ¨æˆ³ä¸ªæ—¶é—´æˆ³ï¼Œç°åœ¨æ˜¯4.30æ˜ŸæœŸæ—¥ã€‚å†™å®Œå‘å‡ºå»åˆä¸çŸ¥é“æ˜¯ä»€ä¹ˆæ—¶å€™å•¦ï¼Œå“ˆå“ˆå“ˆğŸ˜</p>
<p><img src="http://upload-images.jianshu.io/upload_images/1835430-eb798302dcb50708.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="æ‡’ç™Œ"></p>
<p>è¿™ä¸€æœŸè®²ä»€ä¹ˆå‘¢ï¼Ÿè¿™ä¸€æœŸè®²runLoopå“Ÿã€‚ä¸€ç›´ä»¥æ¥ï¼ŒrunLoopè¿™ä¸ª<strong>ç„è€Œåˆç„</strong>çš„ä¸œè¥¿ä¼¼ä¹è¢«å½“åšäº†å…¬å¸é¢è¯•æŒ‘äººçš„ç»ˆæè¯é¢˜ï¼ŒåŸå› ä¸éš¾æƒ³ï¼Œæ—¥å¸¸å¼€å‘ç”¨åˆ°<code>runLoopçš„åœ°æ–¹å°‘ä¹‹åˆå°‘</code>ï¼Œæ²¡æœ‰æ—¶é—´çš„ç§¯ç´¯è¿™æ–¹é¢çš„çŸ¥è¯†åº”è¯¥è¿˜æ˜¯ç›¸å¯¹è¾ƒäºåŒ®ä¹çš„ï¼Œ<code>æ‰€ä»¥runLoopçš„äº†è§£ä¾§é¢ä¹Ÿèƒ½å‘åº”å¼€å‘è€…çš„å¼€å‘ç»éªŒ</code>ï¼Œå½“ç„¶å°±è¢«å½“åšç”„é€‰äººæ‰çš„æœ€åæ€å™¨ã€‚ä½ å¯èƒ½ä¸€è„¸æ„¤æ€’çš„è¯´å¹³æ—¶æœ‰ç”¨ä¸åˆ°ï¼Œæˆ‘ä¸ä¼šä¹Ÿä¸å½±å“å¼€å‘å•Šï¼çš„ç¡®ï¼Œç”¨ä¸åˆ°ï¼Œä½†è¿™åªæ˜¯ä¸€ä¸ªè¿‡æ»¤å™¨è€Œå·²ã€‚<strong>ä½†æ˜¯è›‹ç–¼çš„æ˜¯ï¼Œåœ¨äºå›½å†…çš„ç¯å¢ƒä¸‹ï¼ŒrunLoopçš„ç›¸å…³èµ„æ–™åˆæ˜¯å°‘ä¹‹åˆå°‘ï¼Œå¼€å‘è€…åˆéš¾ä»¥æœ‰ä¸€ä¸ªæ·±å…¥çš„äº†è§£</strong>ã€‚</p>
<p>å‡ºäºä»¥ä¸ŠåŸå› ï¼Œè€å¸æœºä»Šå¤©å°±ä»¥<strong>è€å¸æœºä¸ªäººçš„è§’åº¦</strong>ï¼Œå°½å¯èƒ½å°†è€å¸æœºæ‰€äº†è§£åˆ°çš„runLoopçŸ¥è¯†ã€‚</p>
<p>åœ¨ä»Šå¤©çš„æ–‡ç« ä¸­ä½ å¯èƒ½ä¼šçœ‹åˆ°ä»¥ä¸‹å†…å®¹ï¼š</p>
<ul>
<li>runLoopç›¸å…³çŸ¥è¯†</li>
</ul>
<a id="more"></a>
<hr>
<h1 id="runLoopæ˜¯ä»€ä¹ˆ"><a href="#runLoopæ˜¯ä»€ä¹ˆ" class="headerlink" title="runLoopæ˜¯ä»€ä¹ˆ"></a>runLoopæ˜¯ä»€ä¹ˆ</h1><p>ç›´è¯‘ä»¥ä¸‹ï¼Œè·‘åœˆã€‚ç¿»è¯‘ä»¥ä¸‹ï¼Œ<code>äº‹ä»¶å¾ªç¯</code>å§ã€‚<br>ä¸ºä»€ä¹ˆè¦æœ‰è¿™ä¸ªäº‹ä»¶å¾ªç¯å‘¢ï¼Ÿæˆ‘ä»¬çŸ¥é“ï¼Œä»»ä½•ç¨‹åºå¦‚æœæ‰§è¡Œåˆ°ç¨‹åºçš„æœ€åä¸€å¥ä¹‹åéƒ½ä¼šç»“æŸè¿è¡Œã€‚ç„¶è€Œå¯¹äºæˆ‘ä»¬è¦çš„æ‰‹æœºåº”ç”¨ç¨‹åºè€Œè¨€ï¼Œä»–æ˜¾ç„¶ä¸å¯ä»¥æ‰§è¡Œä¸€ä¸ªäº‹ä»¶åå°±ç»“æŸè¿è¡Œï¼Œä»–åº”è¯¥å…·æœ‰<code>æŒç»­æ¥å—äº‹ä»¶</code>çš„èƒ½åŠ›ä»è€Œä¸æ–­åœ°å¤„ç†äº‹ä»¶ã€‚æ‰€ä»¥æœ€åŸºæœ¬çš„æ€è·¯å°±æ˜¯ç”¨äºä¸ª<code>whileå¾ªç¯</code>è®©ç¨‹åºä¸èƒ½èµ°åˆ°æœ€åä¸€å¥ç»“æŸï¼Œè€Œæ˜¯åœ¨å¾ªç¯ä½“å†…ä¸æ–­çš„æ¥å—äº‹ä»¶ã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦runLoopã€‚ä¸è¿‡å€¼å¾—æ³¨æ„çš„æ˜¯ï¼ŒrunLoopå¹¶ä¸æ˜¯iOSç‹¬æœ‰çš„æ¦‚å¿µï¼Œå› ä¸ºå‡†å»çš„æ¥è¯´<code>runLoopåº”è¯¥æ˜¯ä¸€ä¸ªæ¨¡å¼ï¼Œåœ¨å…¶ä»–å¹³å°åŒæ ·å­˜åœ¨è¿™ç§æ¨¡å¼</code>ï¼Œä¸è¿‡å«ä¸å«runLoopæˆ‘å°±ä¸çŸ¥é“äº†ã€‚</p>
<p><img src="http://upload-images.jianshu.io/upload_images/1835430-9f5079fdc39bf56f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="å¾ªç¯"></p>
<hr>
<h1 id="runLoopæ˜¯å¦‚ä½•å®ç°çš„"><a href="#runLoopæ˜¯å¦‚ä½•å®ç°çš„" class="headerlink" title="runLoopæ˜¯å¦‚ä½•å®ç°çš„"></a>runLoopæ˜¯å¦‚ä½•å®ç°çš„</h1><p>é¦–å…ˆè¦æ˜ç¡®çš„ä¸€ç‚¹äº‹ï¼Œåœ¨å¹³æ—¶æˆ‘ä»¬ä½¿ç”¨çš„æ˜¯Foundationæ¡†æ¶çš„NSRunLoopç±»å»åšä¸€äº›å®ç°ï¼Œè€Œå…¶å®NSRunLoopæ˜¯åŸºäºCoreFoundationæ¡†æ¶ä¸­çš„CFRunLoopè¿›è¡Œçš„ä¸€å±‚ç®€å•çš„å°è£…ã€‚æ‰€ä»¥æˆ‘ä»¬è¿™é‡Œç€é‡ä»‹ç»<strong>CFRunLoop</strong>ï¼Œæ¯•ç«Ÿæˆ‘ä»¬èƒ½æ‹¿åˆ°<a href="http://opensource.apple.com/tarballs/CF/CF-855.17.tar.gz" target="_blank" rel="external">CFRunLoopçš„æºç </a>ã€‚</p>
<h2 id="runLoopçš„ç»„æˆ"><a href="#runLoopçš„ç»„æˆ" class="headerlink" title="runLoopçš„ç»„æˆ"></a>runLoopçš„ç»„æˆ</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">struct __CFRunLoop &#123;</div><div class="line">    CFRuntimeBase _base;</div><div class="line">    pthread_mutex_t _lock;			/* locked for accessing mode list */</div><div class="line">    __CFPort _wakeUpPort;			// used for CFRunLoopWakeUp </div><div class="line">    Boolean _unused;</div><div class="line">    volatile _per_run_data *_perRunData;              // reset for runs of the run loop</div><div class="line">    pthread_t _pthread;</div><div class="line">    uint32_t _winthread;</div><div class="line">    CFMutableSetRef _commonModes;</div><div class="line">    CFMutableSetRef _commonModeItems;</div><div class="line">    CFRunLoopModeRef _currentMode;</div><div class="line">    CFMutableSetRef _modes;</div><div class="line">    struct _block_item *_blocks_head;</div><div class="line">    struct _block_item *_blocks_tail;</div><div class="line">    CFTypeRef _counterpart;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>æˆ‘ä»¬å¤§æ¦‚å¯ä»¥CFRunLoopæ˜¯è¿™ä¹ˆä¸€ä¸ªç»“æ„ä½“ã€‚<br>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ç»“æ„ä½“é‡æœ‰ç”¨æ¥ä¿è¯çº¿ç¨‹å®‰å…¨çš„é”<code>_lock</code>ï¼Œæœ‰ç”¨æ¥å”¤é†’runLoopçš„ç«¯å£<code>_wakeUpPort</code>ï¼ˆè¿™é‡Œåé¢ä¼šè¯´åˆ°ï¼Œä¸ç”¨æ‰§ç€ï¼‰ï¼Œæœ‰çº¿ç¨‹å¯¹è±¡<code>_pthread</code>ï¼Œè¿˜æœ‰ä¸€ä¸ªæ¨¡å¼é›†åˆ<code>_modes</code>ä»¥åŠä¸€äº›å…¶ä»–è¾…åŠ©çš„å±æ€§ã€‚</p>
<h3 id="pthread"><a href="#pthread" class="headerlink" title="_pthread"></a>_pthread</h3><p>è¿™é‡Œæˆ‘è¦è¯´çš„æ˜¯ï¼ŒrunLoopä¸çº¿ç¨‹æ˜¯ä¸€ä¸€å¯¹åº”çš„ã€‚ä¹Ÿå°±æ˜¯è¯´<strong>ä¸€ä¸ªrunLoopå¯¹åº”ç€ä¸€ä¸ªçº¿ç¨‹ï¼Œä¸€ä¸ªçº¿ç¨‹å¯¹åº”ç€ä¸€ä¸ªrunLoop</strong>ã€‚è¿™é‡Œæˆ‘ä»¬ä»runLoopçš„æ„é€ å‡½æ•°å’Œè·å–å‡½æ•°å³å¯çœ‹å‡ºï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">static CFRunLoopRef __CFRunLoopCreate(pthread_t t) &#123;</div><div class="line">    CFRunLoopRef loop = NULL;</div><div class="line">    CFRunLoopModeRef rlm;</div><div class="line">    uint32_t size = sizeof(struct __CFRunLoop) - sizeof(CFRuntimeBase);</div><div class="line">    loop = (CFRunLoopRef)_CFRuntimeCreateInstance(kCFAllocatorSystemDefault, __kCFRunLoopTypeID, size, NULL);</div><div class="line">    if (NULL == loop) &#123;</div><div class="line">	return NULL;</div><div class="line">    &#125;</div><div class="line">    (void)__CFRunLoopPushPerRunData(loop);</div><div class="line">    __CFRunLoopLockInit(&amp;loop-&gt;_lock);</div><div class="line">    loop-&gt;_wakeUpPort = __CFPortAllocate();</div><div class="line">    if (CFPORT_NULL == loop-&gt;_wakeUpPort) HALT;</div><div class="line">    __CFRunLoopSetIgnoreWakeUps(loop);</div><div class="line">    loop-&gt;_commonModes = CFSetCreateMutable(kCFAllocatorSystemDefault, 0, &amp;kCFTypeSetCallBacks);</div><div class="line">    CFSetAddValue(loop-&gt;_commonModes, kCFRunLoopDefaultMode);</div><div class="line">    loop-&gt;_commonModeItems = NULL;</div><div class="line">    loop-&gt;_currentMode = NULL;</div><div class="line">    loop-&gt;_modes = CFSetCreateMutable(kCFAllocatorSystemDefault, 0, &amp;kCFTypeSetCallBacks);</div><div class="line">    loop-&gt;_blocks_head = NULL;</div><div class="line">    loop-&gt;_blocks_tail = NULL;</div><div class="line">    loop-&gt;_counterpart = NULL;</div><div class="line">    loop-&gt;_pthread = t;</div><div class="line">#if DEPLOYMENT_TARGET_WINDOWS</div><div class="line">    loop-&gt;_winthread = GetCurrentThreadId();</div><div class="line">#else</div><div class="line">    loop-&gt;_winthread = 0;</div><div class="line">#endif</div><div class="line">    rlm = __CFRunLoopFindMode(loop, kCFRunLoopDefaultMode, true);</div><div class="line">    if (NULL != rlm) __CFRunLoopModeUnlock(rlm);</div><div class="line">    return loop;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹å‡ºæ„é€ ä¸€ä¸ªrunLoopå¯¹è±¡ä»…éœ€è¦ä¸€ä¸ª<strong>pthread_t</strong>çº¿ç¨‹å³å¯ã€‚å³ä¸€ä¸ªrunLoopå¯¹åº”ä¸€ä¸ªçº¿ç¨‹ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line">CF_EXPORT CFRunLoopRef _CFRunLoopGet0(pthread_t t) &#123;</div><div class="line">    if (pthread_equal(t, kNilPthreadT)) &#123;//å¦‚æœä¼ å…¥çº¿ç¨‹ä¸ºç©ºæŒ‡é’ˆåˆ™é»˜è®¤å–ä¸»çº¿ç¨‹å¯¹åº”çš„runLoop</div><div class="line">	t = pthread_main_thread_np();</div><div class="line">    &#125;</div><div class="line">    __CFSpinLock(&amp;loopsLock);</div><div class="line">    if (!__CFRunLoops) &#123;//__CFRunLoopså°±æ˜¯ä¸€ä¸ªå…¨å±€å­—å…¸ï¼Œä»¥ä¸‹ä»£ç ä¸ºå¦‚æœå…¨å±€å­—å…¸ä¸å­˜åœ¨åˆ™åˆ›å»ºå…¨å±€å­—å…¸ï¼Œå¹¶å°†ä¸»çº¿ç¨‹å¯¹åº”çš„mainLoopå­˜å…¥å­—å…¸ä¸­</div><div class="line">        __CFSpinUnlock(&amp;loopsLock);</div><div class="line">        CFMutableDictionaryRef dict = CFDictionaryCreateMutable(kCFAllocatorSystemDefault, 0, NULL, &amp;kCFTypeDictionaryValueCallBacks);</div><div class="line">        CFRunLoopRef mainLoop = __CFRunLoopCreate(pthread_main_thread_np());</div><div class="line">        CFDictionarySetValue(dict, pthreadPointer(pthread_main_thread_np()), mainLoop);</div><div class="line">        if (!OSAtomicCompareAndSwapPtrBarrier(NULL, dict, (void * volatile *)&amp;__CFRunLoops)) &#123;</div><div class="line">            CFRelease(dict);</div><div class="line">        &#125;</div><div class="line">        CFRelease(mainLoop);</div><div class="line">        __CFSpinLock(&amp;loopsLock);</div><div class="line">    &#125;</div><div class="line">    CFRunLoopRef loop = (CFRunLoopRef)CFDictionaryGetValue(__CFRunLoops, pthreadPointer(t));//ä»å…¨å±€å­—å…¸ä¸­ï¼Œå–å‡ºå¯¹åº”çº¿ç¨‹çš„runLoop</div><div class="line">    __CFSpinUnlock(&amp;loopsLock);</div><div class="line">    if (!loop) &#123;//è‹¥å¯¹åº”çº¿ç¨‹çš„runLoopä¸ºç©ºï¼Œåˆ™åˆ›å»ºå¯¹åº”ç›¸ä¹˜çš„runLoopå¹¶ä¿å­˜åœ¨å…¨å±€å­—å…¸ä¸­</div><div class="line">        CFRunLoopRef newLoop = __CFRunLoopCreate(t);</div><div class="line">        __CFSpinLock(&amp;loopsLock);</div><div class="line">        loop = (CFRunLoopRef)CFDictionaryGetValue(__CFRunLoops, pthreadPointer(t));</div><div class="line">        if (!loop) &#123;</div><div class="line">            CFDictionarySetValue(__CFRunLoops, pthreadPointer(t), newLoop);</div><div class="line">            loop = newLoop;</div><div class="line">        &#125;</div><div class="line">        // don&apos;t release run loops inside the loopsLock, because CFRunLoopDeallocate may end up taking it</div><div class="line">        __CFSpinUnlock(&amp;loopsLock);</div><div class="line">        CFRelease(newLoop);</div><div class="line">    &#125;</div><div class="line">    if (pthread_equal(t, pthread_self())) &#123;</div><div class="line">        _CFSetTSD(__CFTSDKeyRunLoop, (void *)loop, NULL);</div><div class="line">        if (0 == _CFGetTSD(__CFTSDKeyRunLoopCntr)) &#123;</div><div class="line">            _CFSetTSD(__CFTSDKeyRunLoopCntr, (void *)(PTHREAD_DESTRUCTOR_ITERATIONS-1), (void (*)(void *))__CFFinalizeRunLoop);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    return loop;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™æ˜¯runLoopçš„è·å–å‡½æ•°ï¼Œæˆ‘ä»¬çœ‹åˆ°ç³»ç»Ÿä»ä¸€ä¸ª<strong>å…¨å±€å­—å…¸ä¸­å–å‡ºrunLoop</strong>ï¼Œkeyå°±æ˜¯ä¸€ä¸ªçº¿ç¨‹ï¼Œè¿™è¶³ä»¥è¯´æ˜runLoopä¸çº¿ç¨‹æ˜¯<code>ä¸€ä¸€å¯¹åº”</code>çš„å…³ç³»ã€‚</p>
<p>å€¼å¾—ä¸€æçš„æ˜¯ï¼Œ<code>ä¸€ä¸ªçº¿ç¨‹æœ€å¼€å§‹æ˜¯æ²¡æœ‰å¯¹åº”çš„runLoop</code>çš„ï¼Œæ˜¯<code>åœ¨è°ƒç”¨è·å–å‡½æ•°çš„æ—¶å€™æ‰å¯¹åº”äº†ä¸€ä¸ªrunLoopçš„</code>ã€‚<strong>å› ä¸ºæœ¬èº«è¿™ä¸ªå¯¹åº”å…³ç³»æ˜¯æœ‰runLoopç±»ç®¡ç†çš„ï¼Œè€Œä¸æ˜¯çº¿ç¨‹</strong>ã€‚</p>
<p>å½“ç„¶ä¸Šè¿°ä¸¤ä¸ªä¸ºç§æœ‰apiï¼ŒCFçœŸæ­£å¯¹å¤–æš´éœ²çš„åªæœ‰ä¸¤ä¸ªæ¥å£ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">CF_EXPORT CFRunLoopRef CFRunLoopGetCurrent(void);</div><div class="line">CF_EXPORT CFRunLoopRef CFRunLoopGetMain(void);</div></pre></td></tr></table></figure>
<p>ä¸¤ä¸ªæ–¹æ³•çš„å®ç°å¾ˆç®€å•ï¼Œåªè¦æŠŠå¯¹åº”çš„çº¿ç¨‹ä¼ å…¥è·å–å‡½æ•°å³å¯ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">CFRunLoopRef CFRunLoopGetMain(void) &#123;</div><div class="line">    CHECK_FOR_FORK();</div><div class="line">    static CFRunLoopRef __main = NULL; // no retain needed</div><div class="line">    if (!__main) __main = _CFRunLoopGet0(pthread_main_thread_np()); // no CAS needed</div><div class="line">    return __main;</div><div class="line">&#125;</div><div class="line"></div><div class="line">CFRunLoopRef CFRunLoopGetCurrent(void) &#123;</div><div class="line">    CHECK_FOR_FORK();</div><div class="line">    CFRunLoopRef rl = (CFRunLoopRef)_CFGetTSD(__CFTSDKeyRunLoop);</div><div class="line">    if (rl) return rl;</div><div class="line">    return _CFRunLoopGet0(pthread_self());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<h3 id="modes"><a href="#modes" class="headerlink" title="_modes"></a>_modes</h3><p>æˆ‘ä»¬çœ‹åˆ°ï¼Œä¸€ä¸ªrunLoopä¸­åŒæ—¶è¿˜ç»´æŠ¤ç€ä¸€ä¸ªé›†åˆï¼Œ_modesã€‚é‚£ä¹ˆè¿™ä¸ªmodesæ˜¯åšä»€ä¹ˆçš„å‘¢ï¼Ÿåº”è¯¥è¯´ï¼Œ_modesæ‰æ˜¯<code>runLoopçš„æ ¸å¿ƒ</code>ã€‚å’³å’³ï¼ˆæ•²é»‘æ¿ï¼‰ï¼Œåˆ’é‡ç‚¹äº†å•Šã€‚</p>
<p>é¦–å…ˆæˆ‘ä»¬çœ‹ä¸€ä¸‹è¿™ä¸ª_modesé‡Œé¢åˆ°åº•éƒ½è£…äº†äº›ä»€ä¹ˆï¼Ÿ<br>ç­”æ¡ˆæ˜¯<code>__CFRunLoopMode</code>å¯¹è±¡ã€‚é‚£ä¹ˆä»–åˆæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">struct __CFRunLoopMode &#123;</div><div class="line">    CFRuntimeBase _base;</div><div class="line">    pthread_mutex_t _lock;	/* must have the run loop locked before locking this */</div><div class="line">    CFStringRef _name;</div><div class="line">    Boolean _stopped;</div><div class="line">    char _padding[3];</div><div class="line">    CFMutableSetRef _sources0;</div><div class="line">    CFMutableSetRef _sources1;</div><div class="line">    CFMutableArrayRef _observers;</div><div class="line">    CFMutableArrayRef _timers;</div><div class="line">    CFMutableDictionaryRef _portToV1SourceMap;</div><div class="line">    __CFPortSet _portSet;</div><div class="line">    CFIndex _observerMask;</div><div class="line">#if USE_DISPATCH_SOURCE_FOR_TIMERS</div><div class="line">    dispatch_source_t _timerSource;</div><div class="line">    dispatch_queue_t _queue;</div><div class="line">    Boolean _timerFired; // set to true by the source when a timer has fired</div><div class="line">    Boolean _dispatchTimerArmed;</div><div class="line">#endif</div><div class="line">#if USE_MK_TIMER_TOO</div><div class="line">    mach_port_t _timerPort;</div><div class="line">    Boolean _mkTimerArmed;</div><div class="line">#endif</div><div class="line">#if DEPLOYMENT_TARGET_WINDOWS</div><div class="line">    DWORD _msgQMask;</div><div class="line">    void (*_msgPump)(void);</div><div class="line">#endif</div><div class="line">    uint64_t _timerSoftDeadline; /* TSR */</div><div class="line">    uint64_t _timerHardDeadline; /* TSR */</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>è¿™é‡Œè€å¸æœºæŒ‘å‡ºäº†å‡ ä¸ªé‡ç‚¹ï¼Œæœ‰ç”¨æ¥æ ‡å¿—runLoopModeçš„æ ‡å¿—<code>_name</code>ï¼Œæœ‰ä¸¤ä¸ªäº‹ä»¶æºçš„é›†åˆ<code>_sources0ã€_sources1</code>ï¼Œæœ‰ä¸€ç»„è§‚å¯Ÿè€…<code>_obeserver</code>ï¼Œæœ‰ä¸€ç»„è¢«åŠ å…¥åˆ°runLoopä¸­çš„<code>_timers</code>ï¼Œè¿˜æœ‰Modeæœ¬èº«ç»´æŠ¤ç€çš„ä¸€ä¸ªç”¨äºè®¡æ—¶çš„<code>_timerSource</code>ï¼Œ<code>_timerPort</code>ã€‚è¿™ä¸¤ä¸ªä¸€ä¸ªæ˜¯GCDæ—¶é’Ÿä¸€ä¸ªæ˜¯å†…æ ¸æ—¶é’Ÿã€‚</p>
<p>è‡³äºrunLoopModeä¸ºä»€ä¹ˆé•¿è¿™æ ·ï¼Œè€å¸æœºä¼šåœ¨ä¸‹é¢runLoopRunçš„å®ç°ä¸­ç»“åˆä»£ç è®²åˆ°ã€‚</p>
<hr>
<h2 id="runLoopä»£ç å®ç°"><a href="#runLoopä»£ç å®ç°" class="headerlink" title="runLoopä»£ç å®ç°"></a>runLoopä»£ç å®ç°</h2><p>æ©ï¼Œæ¥ä¸‹æ¥ä»£ç æœ‰ç‚¹é•¿ï¼Œå…ˆç»™ä½ ä»¬çœ‹ä¸€ä¸‹å¤§æ¦‚æµç¨‹ï¼Œç„¶åå¯¹ç€æµç¨‹å»çœ‹ä¸€ä¸‹ä»£ç ã€‚</p>
<p><img src="http://upload-images.jianshu.io/upload_images/1835430-a84a8802abc125cb.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="å›¾æ˜¯æˆ‘ç›—çš„"></p>
<p>å‰æ–¹é«˜èƒ½é¢„è­¦ï¼Œä»£ç å¾ˆå¤šï¼</p>
<p>runLoopæ ¸å¿ƒä»£ç </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div></pre></td><td class="code"><pre><div class="line">/* rl, rlm are locked on entrance and exit */</div><div class="line">static int32_t __CFRunLoopRun(CFRunLoopRef rl, CFRunLoopModeRef rlm, CFTimeInterval seconds, Boolean stopAfterHandle, CFRunLoopModeRef previousMode) &#123;</div><div class="line">    uint64_t startTSR = mach_absolute_time();//è·å–å½“å‰å†…æ ¸æ—¶é—´</div><div class="line">    </div><div class="line">    if (__CFRunLoopIsStopped(rl)) &#123;//å¦‚æœå½“å‰runLoopæˆ–è€…runLoopModeä¸ºåœæ­¢çŠ¶æ€çš„è¯ç›´æ¥è¿”å›</div><div class="line">        __CFRunLoopUnsetStopped(rl);</div><div class="line">        return kCFRunLoopRunStopped;</div><div class="line">    &#125; else if (rlm-&gt;_stopped) &#123;</div><div class="line">        rlm-&gt;_stopped = false;</div><div class="line">        return kCFRunLoopRunStopped;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    //åˆ¤æ–­æ˜¯å¦æ˜¯ç¬¬ä¸€æ¬¡åœ¨ä¸»çº¿ç¨‹ä¸­å¯åŠ¨RunLoop,å¦‚æœæ˜¯ä¸”å½“å‰RunLoopä¸ºä¸»çº¿ç¨‹çš„RunLoopï¼Œé‚£ä¹ˆå°±ç»™åˆ†å‘ä¸€ä¸ªé˜Ÿåˆ—è°ƒåº¦ç«¯å£</div><div class="line">    mach_port_name_t dispatchPort = MACH_PORT_NULL;</div><div class="line">    Boolean libdispatchQSafe = pthread_main_np() &amp;&amp; ((HANDLE_DISPATCH_ON_BASE_INVOCATION_ONLY &amp;&amp; NULL == previousMode) || (!HANDLE_DISPATCH_ON_BASE_INVOCATION_ONLY &amp;&amp; 0 == _CFGetTSD(__CFTSDKeyIsInGCDMainQ)));</div><div class="line">    if (libdispatchQSafe &amp;&amp; (CFRunLoopGetMain() == rl) &amp;&amp; CFSetContainsValue(rl-&gt;_commonModes, rlm-&gt;_name)) dispatchPort = _dispatch_get_main_queue_port_4CF();</div><div class="line">    </div><div class="line">#if USE_DISPATCH_SOURCE_FOR_TIMERS</div><div class="line"></div><div class="line">	//ç»™å½“å‰æ¨¡å¼åˆ†å‘é˜Ÿåˆ—ç«¯å£</div><div class="line">    mach_port_name_t modeQueuePort = MACH_PORT_NULL;</div><div class="line">    if (rlm-&gt;_queue) &#123;</div><div class="line">        modeQueuePort = _dispatch_runloop_root_queue_get_port_4CF(rlm-&gt;_queue);</div><div class="line">        if (!modeQueuePort) &#123;</div><div class="line">            CRASH(&quot;Unable to get port for run loop mode queue (%d)&quot;, -1);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">#endif</div><div class="line">    </div><div class="line">    //åˆå§‹åŒ–ä¸€ä¸ªGCDè®¡æ—¶å™¨ï¼Œç”¨äºç®¡ç†å½“å‰æ¨¡å¼çš„è¶…æ—¶</div><div class="line">    dispatch_source_t timeout_timer = NULL;</div><div class="line">    struct __timeout_context *timeout_context = (struct __timeout_context *)malloc(sizeof(*timeout_context));</div><div class="line">    if (seconds &lt;= 0.0) &#123; // instant timeout</div><div class="line">        seconds = 0.0;</div><div class="line">        timeout_context-&gt;termTSR = 0ULL;</div><div class="line">    &#125; else if (seconds &lt;= TIMER_INTERVAL_LIMIT) &#123;</div><div class="line">        dispatch_queue_t queue = dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_HIGH, DISPATCH_QUEUE_OVERCOMMIT);</div><div class="line">        timeout_timer = dispatch_source_create(DISPATCH_SOURCE_TYPE_TIMER, 0, 0, queue);</div><div class="line">        dispatch_retain(timeout_timer);</div><div class="line">        timeout_context-&gt;ds = timeout_timer;</div><div class="line">        timeout_context-&gt;rl = (CFRunLoopRef)CFRetain(rl);</div><div class="line">        timeout_context-&gt;termTSR = startTSR + __CFTimeIntervalToTSR(seconds);</div><div class="line">        dispatch_set_context(timeout_timer, timeout_context); // source gets ownership of context</div><div class="line">        dispatch_source_set_event_handler_f(timeout_timer, __CFRunLoopTimeout);</div><div class="line">        dispatch_source_set_cancel_handler_f(timeout_timer, __CFRunLoopTimeoutCancel);</div><div class="line">        uint64_t ns_at = (uint64_t)((__CFTSRToTimeInterval(startTSR) + seconds) * 1000000000ULL);</div><div class="line">        dispatch_source_set_timer(timeout_timer, dispatch_time(1, ns_at), DISPATCH_TIME_FOREVER, 1000ULL);</div><div class="line">        dispatch_resume(timeout_timer);</div><div class="line">    &#125; else &#123; // infinite timeout</div><div class="line">        seconds = 9999999999.0;</div><div class="line">        timeout_context-&gt;termTSR = UINT64_MAX;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    // ç¬¬ä¸€æ­¥ï¼Œè¿›å…¥å¾ªç¯</div><div class="line">    Boolean didDispatchPortLastTime = true;</div><div class="line">    int32_t retVal = 0;</div><div class="line">    do &#123;</div><div class="line">        uint8_t msg_buffer[3 * 1024];</div><div class="line">#if DEPLOYMENT_TARGET_MACOSX || DEPLOYMENT_TARGET_EMBEDDED || DEPLOYMENT_TARGET_EMBEDDED_MINI</div><div class="line">        mach_msg_header_t *msg = NULL;</div><div class="line">        mach_port_t livePort = MACH_PORT_NULL;</div><div class="line">#elif DEPLOYMENT_TARGET_WINDOWS</div><div class="line">        HANDLE livePort = NULL;</div><div class="line">        Boolean windowsMessageReceived = false;</div><div class="line">#endif</div><div class="line">        __CFPortSet waitSet = rlm-&gt;_portSet;</div><div class="line">        </div><div class="line">        //è®¾ç½®å½“å‰å¾ªç¯ç›‘å¬ç«¯å£çš„å”¤é†’</div><div class="line">        __CFRunLoopUnsetIgnoreWakeUps(rl);</div><div class="line">        </div><div class="line">        // ç¬¬äºŒæ­¥ï¼Œé€šçŸ¥è§‚å¯Ÿè€…å‡†å¤‡å¼€å§‹å¤„ç†Timeræºäº‹ä»¶</div><div class="line">        if (rlm-&gt;_observerMask &amp; kCFRunLoopBeforeTimers) __CFRunLoopDoObservers(rl, rlm, kCFRunLoopBeforeTimers);</div><div class="line">        </div><div class="line">        // ç¬¬ä¸‰æ­¥ï¼Œé€šçŸ¥è§‚å¯Ÿè€…å‡†å¤‡å¼€å§‹å¤„ç†Sourceæºäº‹ä»¶</div><div class="line">        if (rlm-&gt;_observerMask &amp; kCFRunLoopBeforeSources) __CFRunLoopDoObservers(rl, rlm, kCFRunLoopBeforeSources);</div><div class="line">        </div><div class="line">        //æ‰§è¡Œæäº¤åˆ°runLoopä¸­çš„block</div><div class="line">        __CFRunLoopDoBlocks(rl, rlm);</div><div class="line">        </div><div class="line">        // ç¬¬å››æ­¥ï¼Œæ‰§è¡Œsource0ä¸­çš„æºäº‹ä»¶</div><div class="line">        Boolean sourceHandledThisLoop = __CFRunLoopDoSources0(rl, rlm, stopAfterHandle);</div><div class="line">        </div><div class="line">        //å¦‚æœå½“å‰source0æºäº‹ä»¶å¤„ç†å®Œæˆåæ‰§è¡Œæäº¤åˆ°runLoopä¸­çš„block</div><div class="line">        if (sourceHandledThisLoop) &#123;</div><div class="line">            __CFRunLoopDoBlocks(rl, rlm);</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        //æ ‡å¿—æ˜¯å¦ç­‰å¾…ç«¯å£å”¤é†’</div><div class="line">        Boolean poll = sourceHandledThisLoop || (0ULL == timeout_context-&gt;termTSR);</div><div class="line">        </div><div class="line">        // ç¬¬äº”æ­¥ï¼Œæ£€æµ‹ç«¯å£ï¼Œå¦‚æœç«¯å£æœ‰äº‹ä»¶åˆ™è·³è½¬è‡³handle_msgï¼ˆé¦–æ¬¡æ‰§è¡Œä¸ä¼šè¿›å…¥åˆ¤æ–­ï¼Œå› ä¸ºdidDispatchPortLastTimeä¸ºtrueï¼‰</div><div class="line">        if (MACH_PORT_NULL != dispatchPort &amp;&amp; !didDispatchPortLastTime) &#123;</div><div class="line">#if DEPLOYMENT_TARGET_MACOSX || DEPLOYMENT_TARGET_EMBEDDED || DEPLOYMENT_TARGET_EMBEDDED_MINI</div><div class="line">            msg = (mach_msg_header_t *)msg_buffer;</div><div class="line">            if (__CFRunLoopServiceMachPort(dispatchPort, &amp;msg, sizeof(msg_buffer), &amp;livePort, 0)) &#123;</div><div class="line">                goto handle_msg;</div><div class="line">            &#125;</div><div class="line">#elif DEPLOYMENT_TARGET_WINDOWS</div><div class="line">            if (__CFRunLoopWaitForMultipleObjects(NULL, &amp;dispatchPort, 0, 0, &amp;livePort, NULL)) &#123;</div><div class="line">                goto handle_msg;</div><div class="line">            &#125;</div><div class="line">#endif</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        didDispatchPortLastTime = false;</div><div class="line">        </div><div class="line">        // ç¬¬å…­æ­¥ï¼Œé€šçŸ¥è§‚å¯Ÿè€…çº¿ç¨‹è¿›å…¥ä¼‘çœ </div><div class="line">        if (!poll &amp;&amp; (rlm-&gt;_observerMask &amp; kCFRunLoopBeforeWaiting)) __CFRunLoopDoObservers(rl, rlm, kCFRunLoopBeforeWaiting);</div><div class="line">        </div><div class="line">        // æ ‡å¿—å½“å‰runLoopä¸ºä¼‘çœ çŠ¶æ€</div><div class="line">        __CFRunLoopSetSleeping(rl);</div><div class="line">        </div><div class="line">        // do not do any user callouts after this point (after notifying of sleeping)</div><div class="line">        </div><div class="line">        // Must push the local-to-this-activation ports in on every loop</div><div class="line">        // iteration, as this mode could be run re-entrantly and we don&apos;t</div><div class="line">        // want these ports to get serviced.</div><div class="line">        </div><div class="line">        __CFPortSetInsert(dispatchPort, waitSet);</div><div class="line">        </div><div class="line">        __CFRunLoopModeUnlock(rlm);</div><div class="line">        __CFRunLoopUnlock(rl);</div><div class="line">   </div><div class="line">   </div><div class="line">   		// ç¬¬ä¸ƒæ­¥ï¼Œè¿›å…¥å¾ªç¯å¼€å§‹ä¸æ–­çš„è¯»å–ç«¯å£ä¿¡æ¯ï¼Œå¦‚æœç«¯å£æœ‰å”¤é†’ä¿¡æ¯åˆ™å”¤é†’å½“å‰runLoop     </div><div class="line">#if DEPLOYMENT_TARGET_MACOSX || DEPLOYMENT_TARGET_EMBEDDED || DEPLOYMENT_TARGET_EMBEDDED_MINI</div><div class="line">#if USE_DISPATCH_SOURCE_FOR_TIMERS</div><div class="line">        do &#123;</div><div class="line">            if (kCFUseCollectableAllocator) &#123;</div><div class="line">                objc_clear_stack(0);</div><div class="line">                memset(msg_buffer, 0, sizeof(msg_buffer));</div><div class="line">            &#125;</div><div class="line">            msg = (mach_msg_header_t *)msg_buffer;</div><div class="line">            __CFRunLoopServiceMachPort(waitSet, &amp;msg, sizeof(msg_buffer), &amp;livePort, poll ? 0 : TIMEOUT_INFINITY);</div><div class="line">            </div><div class="line">            if (modeQueuePort != MACH_PORT_NULL &amp;&amp; livePort == modeQueuePort) &#123;</div><div class="line">                // Drain the internal queue. If one of the callout blocks sets the timerFired flag, break out and service the timer.</div><div class="line">                while (_dispatch_runloop_root_queue_perform_4CF(rlm-&gt;_queue));</div><div class="line">                if (rlm-&gt;_timerFired) &#123;</div><div class="line">                    // Leave livePort as the queue port, and service timers below</div><div class="line">                    rlm-&gt;_timerFired = false;</div><div class="line">                    break;</div><div class="line">                &#125; else &#123;</div><div class="line">                    if (msg &amp;&amp; msg != (mach_msg_header_t *)msg_buffer) free(msg);</div><div class="line">                &#125;</div><div class="line">            &#125; else &#123;</div><div class="line">                // Go ahead and leave the inner loop.</div><div class="line">                break;</div><div class="line">            &#125;</div><div class="line">        &#125; while (1);</div><div class="line">#else</div><div class="line">        if (kCFUseCollectableAllocator) &#123;</div><div class="line">            objc_clear_stack(0);</div><div class="line">            memset(msg_buffer, 0, sizeof(msg_buffer));</div><div class="line">        &#125;</div><div class="line">        msg = (mach_msg_header_t *)msg_buffer;</div><div class="line">        __CFRunLoopServiceMachPort(waitSet, &amp;msg, sizeof(msg_buffer), &amp;livePort, poll ? 0 : TIMEOUT_INFINITY);</div><div class="line">#endif</div><div class="line">        </div><div class="line">        </div><div class="line">#elif DEPLOYMENT_TARGET_WINDOWS</div><div class="line">        // Here, use the app-supplied message queue mask. They will set this if they are interested in having this run loop receive windows messages.</div><div class="line">        __CFRunLoopWaitForMultipleObjects(waitSet, NULL, poll ? 0 : TIMEOUT_INFINITY, rlm-&gt;_msgQMask, &amp;livePort, &amp;windowsMessageReceived);</div><div class="line">#endif</div><div class="line">        </div><div class="line">        __CFRunLoopLock(rl);</div><div class="line">        __CFRunLoopModeLock(rlm);</div><div class="line">        </div><div class="line">        // Must remove the local-to-this-activation ports in on every loop</div><div class="line">        // iteration, as this mode could be run re-entrantly and we don&apos;t</div><div class="line">        // want these ports to get serviced. Also, we don&apos;t want them left</div><div class="line">        // in there if this function returns.</div><div class="line">        </div><div class="line">        __CFPortSetRemove(dispatchPort, waitSet);</div><div class="line">        </div><div class="line">        //æ ‡å¿—å½“å‰runLoopä¸ºå”¤é†’çŠ¶æ€</div><div class="line">        __CFRunLoopSetIgnoreWakeUps(rl);</div><div class="line">        </div><div class="line">        // user callouts now OK again</div><div class="line">        __CFRunLoopUnsetSleeping(rl);</div><div class="line">        </div><div class="line">        // ç¬¬å…«æ­¥ï¼Œé€šçŸ¥è§‚å¯Ÿè€…çº¿ç¨‹è¢«å”¤é†’äº†</div><div class="line">        if (!poll &amp;&amp; (rlm-&gt;_observerMask &amp; kCFRunLoopAfterWaiting)) __CFRunLoopDoObservers(rl, rlm, kCFRunLoopAfterWaiting);</div><div class="line">        </div><div class="line">        //æ‰§è¡Œç«¯å£çš„äº‹ä»¶</div><div class="line">    handle_msg:;</div><div class="line">    </div><div class="line">    	//è®¾ç½®æ­¤æ—¶runLoopå¿½ç•¥ç«¯å£å”¤é†’ï¼ˆä¿è¯çº¿ç¨‹å®‰å…¨ï¼‰</div><div class="line">        __CFRunLoopSetIgnoreWakeUps(rl);</div><div class="line">        </div><div class="line">#if DEPLOYMENT_TARGET_WINDOWS</div><div class="line">        if (windowsMessageReceived) &#123;</div><div class="line">            // These Win32 APIs cause a callout, so make sure we&apos;re unlocked first and relocked after</div><div class="line">            __CFRunLoopModeUnlock(rlm);</div><div class="line">            __CFRunLoopUnlock(rl);</div><div class="line">            </div><div class="line">            if (rlm-&gt;_msgPump) &#123;</div><div class="line">                rlm-&gt;_msgPump();</div><div class="line">            &#125; else &#123;</div><div class="line">                MSG msg;</div><div class="line">                if (PeekMessage(&amp;msg, NULL, 0, 0, PM_REMOVE | PM_NOYIELD)) &#123;</div><div class="line">                    TranslateMessage(&amp;msg);</div><div class="line">                    DispatchMessage(&amp;msg);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            </div><div class="line">            __CFRunLoopLock(rl);</div><div class="line">            __CFRunLoopModeLock(rlm);</div><div class="line">            sourceHandledThisLoop = true;</div><div class="line">            </div><div class="line">            // To prevent starvation of sources other than the message queue, we check again to see if any other sources need to be serviced</div><div class="line">            // Use 0 for the mask so windows messages are ignored this time. Also use 0 for the timeout, because we&apos;re just checking to see if the things are signalled right now -- we will wait on them again later.</div><div class="line">            // NOTE: Ignore the dispatch source (it&apos;s not in the wait set anymore) and also don&apos;t run the observers here since we are polling.</div><div class="line">            __CFRunLoopSetSleeping(rl);</div><div class="line">            __CFRunLoopModeUnlock(rlm);</div><div class="line">            __CFRunLoopUnlock(rl);</div><div class="line">            </div><div class="line">            __CFRunLoopWaitForMultipleObjects(waitSet, NULL, 0, 0, &amp;livePort, NULL);</div><div class="line">            </div><div class="line">            __CFRunLoopLock(rl);</div><div class="line">            __CFRunLoopModeLock(rlm);</div><div class="line">            __CFRunLoopUnsetSleeping(rl);</div><div class="line">            // If we have a new live port then it will be handled below as normal</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        </div><div class="line">#endif</div><div class="line"></div><div class="line">		// ç¬¬ä¹æ­¥ï¼Œå¤„ç†ç«¯å£äº‹ä»¶</div><div class="line">        if (MACH_PORT_NULL == livePort) &#123;</div><div class="line">            CFRUNLOOP_WAKEUP_FOR_NOTHING();</div><div class="line">            // handle nothing</div><div class="line">        &#125; else if (livePort == rl-&gt;_wakeUpPort) &#123;</div><div class="line">            CFRUNLOOP_WAKEUP_FOR_WAKEUP();</div><div class="line">            // do nothing on Mac OS</div><div class="line">#if DEPLOYMENT_TARGET_WINDOWS</div><div class="line">            // Always reset the wake up port, or risk spinning forever</div><div class="line">            ResetEvent(rl-&gt;_wakeUpPort);</div><div class="line">#endif</div><div class="line">        &#125;</div><div class="line">#if USE_DISPATCH_SOURCE_FOR_TIMERS</div><div class="line">        else if (modeQueuePort != MACH_PORT_NULL &amp;&amp; livePort == modeQueuePort) &#123;</div><div class="line">            CFRUNLOOP_WAKEUP_FOR_TIMER();</div><div class="line">            if (!__CFRunLoopDoTimers(rl, rlm, mach_absolute_time())) &#123;</div><div class="line">                // Re-arm the next timer, because we apparently fired early</div><div class="line">                __CFArmNextTimerInMode(rlm, rl);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">#endif</div><div class="line">#if USE_MK_TIMER_TOO</div><div class="line">        else if (rlm-&gt;_timerPort != MACH_PORT_NULL &amp;&amp; livePort == rlm-&gt;_timerPort) &#123;//å¤„ç†å®šæ—¶å™¨äº‹ä»¶</div><div class="line">            CFRUNLOOP_WAKEUP_FOR_TIMER();</div><div class="line">            // On Windows, we have observed an issue where the timer port is set before the time which we requested it to be set. For example, we set the fire time to be TSR 167646765860, but it is actually observed firing at TSR 167646764145, which is 1715 ticks early. The result is that, when __CFRunLoopDoTimers checks to see if any of the run loop timers should be firing, it appears to be &apos;too early&apos; for the next timer, and no timers are handled.</div><div class="line">            // In this case, the timer port has been automatically reset (since it was returned from MsgWaitForMultipleObjectsEx), and if we do not re-arm it, then no timers will ever be serviced again unless something adjusts the timer list (e.g. adding or removing timers). The fix for the issue is to reset the timer here if CFRunLoopDoTimers did not handle a timer itself. 9308754</div><div class="line">            if (!__CFRunLoopDoTimers(rl, rlm, mach_absolute_time())) &#123;</div><div class="line">                // Re-arm the next timer</div><div class="line">                __CFArmNextTimerInMode(rlm, rl);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">#endif</div><div class="line">		//å¤„ç†æœ‰GCDæäº¤åˆ°ä¸»çº¿ç¨‹å”¤é†’çš„äº‹ä»¶</div><div class="line">        else if (livePort == dispatchPort) &#123;</div><div class="line">            CFRUNLOOP_WAKEUP_FOR_DISPATCH();</div><div class="line">            __CFRunLoopModeUnlock(rlm);</div><div class="line">            __CFRunLoopUnlock(rl);</div><div class="line">            _CFSetTSD(__CFTSDKeyIsInGCDMainQ, (void *)6, NULL);</div><div class="line">#if DEPLOYMENT_TARGET_WINDOWS</div><div class="line">            void *msg = 0;</div><div class="line">#endif</div><div class="line">            __CFRUNLOOP_IS_SERVICING_THE_MAIN_DISPATCH_QUEUE__(msg);</div><div class="line">            _CFSetTSD(__CFTSDKeyIsInGCDMainQ, (void *)0, NULL);</div><div class="line">            __CFRunLoopLock(rl);</div><div class="line">            __CFRunLoopModeLock(rlm);</div><div class="line">            sourceHandledThisLoop = true;</div><div class="line">            didDispatchPortLastTime = true;</div><div class="line">        &#125; else &#123;</div><div class="line">        </div><div class="line">	        //å¤„ç†source1å”¤é†’çš„äº‹ä»¶</div><div class="line">            CFRUNLOOP_WAKEUP_FOR_SOURCE();</div><div class="line">            // Despite the name, this works for windows handles as well</div><div class="line">            CFRunLoopSourceRef rls = __CFRunLoopModeFindSourceForMachPort(rl, rlm, livePort);</div><div class="line">            if (rls) &#123;</div><div class="line">#if DEPLOYMENT_TARGET_MACOSX || DEPLOYMENT_TARGET_EMBEDDED || DEPLOYMENT_TARGET_EMBEDDED_MINI</div><div class="line">                mach_msg_header_t *reply = NULL;</div><div class="line">                // å¤„ç†Source1(åŸºäºç«¯å£çš„æº)</div><div class="line">                sourceHandledThisLoop = __CFRunLoopDoSource1(rl, rlm, rls, msg, msg-&gt;msgh_size, &amp;reply) || sourceHandledThisLoop;</div><div class="line">                if (NULL != reply) &#123;</div><div class="line">                    (void)mach_msg(reply, MACH_SEND_MSG, reply-&gt;msgh_size, 0, MACH_PORT_NULL, 0, MACH_PORT_NULL);</div><div class="line">                    CFAllocatorDeallocate(kCFAllocatorSystemDefault, reply);</div><div class="line">                &#125;</div><div class="line">#elif DEPLOYMENT_TARGET_WINDOWS</div><div class="line">                sourceHandledThisLoop = __CFRunLoopDoSource1(rl, rlm, rls) || sourceHandledThisLoop;</div><div class="line">#endif</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">#if DEPLOYMENT_TARGET_MACOSX || DEPLOYMENT_TARGET_EMBEDDED || DEPLOYMENT_TARGET_EMBEDDED_MINI</div><div class="line">        if (msg &amp;&amp; msg != (mach_msg_header_t *)msg_buffer) free(msg);</div><div class="line">#endif</div><div class="line">        </div><div class="line">        __CFRunLoopDoBlocks(rl, rlm);</div><div class="line">        </div><div class="line">        //è¿”å›å¯¹åº”çš„è¿”å›å€¼å¹¶è·³å‡ºå¾ªç¯</div><div class="line">        if (sourceHandledThisLoop &amp;&amp; stopAfterHandle) &#123;</div><div class="line">            retVal = kCFRunLoopRunHandledSource;</div><div class="line">        &#125; else if (timeout_context-&gt;termTSR &lt; mach_absolute_time()) &#123;</div><div class="line">            retVal = kCFRunLoopRunTimedOut;</div><div class="line">        &#125; else if (__CFRunLoopIsStopped(rl)) &#123;</div><div class="line">            __CFRunLoopUnsetStopped(rl);</div><div class="line">            retVal = kCFRunLoopRunStopped;</div><div class="line">        &#125; else if (rlm-&gt;_stopped) &#123;</div><div class="line">            rlm-&gt;_stopped = false;</div><div class="line">            retVal = kCFRunLoopRunStopped;</div><div class="line">        &#125; else if (__CFRunLoopModeIsEmpty(rl, rlm, previousMode)) &#123;</div><div class="line">            retVal = kCFRunLoopRunFinished;</div><div class="line">        &#125;</div><div class="line">    &#125; while (0 == retVal);</div><div class="line">    </div><div class="line">    // ç¬¬åæ­¥ï¼Œé‡Šæ”¾å®šæ—¶å™¨</div><div class="line">    if (timeout_timer) &#123;</div><div class="line">        dispatch_source_cancel(timeout_timer);</div><div class="line">        dispatch_release(timeout_timer);</div><div class="line">    &#125; else &#123;</div><div class="line">        free(timeout_context);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    return retVal;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™ä¸ªæ–¹æ³•æœ‰ç‚¹æœ‰ç‚¹é•¿ï¼Œ300è¡Œä»£ç =ã€‚=</p>
<p>è¿™300è¡Œçš„æµç¨‹å…¶å®å°±æ˜¯ä¸Šé¢å½’çº³çš„10æ­¥ï¼š</p>
<blockquote>
<p>é¦–å…ˆè¿›å…¥runLoopå¯¹åº”çš„Modeå¹¶å¼€å§‹å¾ªç¯ï¼Œç„¶ååœ¨ä¼‘çœ ä¹‹å‰åšäº†ä¸‰ä»¶äº‹ï¼šDoBlocksã€DoSource0ã€æ£€æµ‹source1ç«¯å£æ˜¯å¦æœ‰æ¶ˆæ¯ï¼Œå¦‚æœæœ‰åˆ™è·³è¿‡ç¨åçš„ä¼‘çœ ã€‚<br>ç„¶årunLoopå°±è¿›å…¥äº†ä¼‘çœ çŠ¶æ€ï¼Œç›´åˆ°æœ‰ç«¯å£äº‹ä»¶å”¤é†’runLoopï¼Œè¢«å”¤é†’ååˆ™å¤„ç†å“åº”çš„ç«¯å£äº‹ä»¶ç„¶åå†æ¬¡å¼€å§‹å¾ªç¯ã€‚ç›´åˆ°runLoopè¶…æ—¶æˆ–è€…runLoopè¢«åœæ­¢ååœ¨ç»“æŸrunLoopã€‚</p>
</blockquote>
<p>ä¸è¿‡å¥½åœ¨ä»£ç å¾ˆå…¨ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬èƒ½å‡ºåˆ°å¾ˆå¤šé—®é¢˜ã€‚</p>
<h3 id="source0ï¼Œsource1"><a href="#source0ï¼Œsource1" class="headerlink" title="source0ï¼Œsource1"></a>source0ï¼Œsource1</h3><p>é¦–å…ˆè¿™ä¸ªæºäº‹ä»¶åˆ†ä¸ºä¸¤ç§ï¼Œä¸€ç§æ˜¯ä¸åŸºäºç«¯å£çš„source0ï¼Œä¸€ç›´æ˜¯åŸºäºç«¯å£çš„source1ã€‚</p>
<blockquote>
<p>Source0 åªåŒ…å«äº†ä¸€ä¸ªå›è°ƒï¼ˆå‡½æ•°æŒ‡é’ˆï¼‰ï¼Œå®ƒå¹¶ä¸èƒ½ä¸»åŠ¨è§¦å‘äº‹ä»¶ã€‚ä½¿ç”¨æ—¶ï¼Œä½ éœ€è¦å…ˆè°ƒç”¨ CFRunLoopSourceSignal(source)ï¼Œå°†è¿™ä¸ª Source æ ‡è®°ä¸ºå¾…å¤„ç†ï¼Œç„¶åæ‰‹åŠ¨è°ƒç”¨ CFRunLoopWakeUp(runloop) æ¥å”¤é†’ RunLoopï¼Œè®©å…¶å¤„ç†è¿™ä¸ªäº‹ä»¶ã€‚</p>
<p>Source1 åŒ…å«äº†ä¸€ä¸ª mach_port å’Œä¸€ä¸ªå›è°ƒï¼ˆå‡½æ•°æŒ‡é’ˆï¼‰ï¼Œè¢«ç”¨äºé€šè¿‡å†…æ ¸å’Œå…¶ä»–çº¿ç¨‹ç›¸äº’å‘é€æ¶ˆæ¯ã€‚è¿™ç§ Source èƒ½ä¸»åŠ¨å”¤é†’ RunLoop çš„çº¿ç¨‹ï¼Œå…¶åŸç†åœ¨ä¸‹é¢ä¼šè®²åˆ°ã€‚</p>
<p>â€”â€”â€”â€”<a href="http://blog.ibireme.com/2015/05/18/runloop/" target="_blank" rel="external">å¼•è‡ªæ·±å…¥ç†è§£RunLoop
</a></p>
</blockquote>
<hr>
<blockquote>
<p>source0å‘¢ä¸»è¦å¤„ç†Appå†…éƒ¨äº‹ä»¶ã€Appè‡ªå·±è´Ÿè´£ç®¡ç†ï¼ˆè§¦å‘ï¼‰ï¼Œå¦‚UIEventã€CFSocket</p>
<p>source1å‘¢ä¸»è¦æœ‰Runloopå’Œå†…æ ¸ç®¡ç†ï¼ŒMach porté©±åŠ¨ï¼Œå¦‚CFMahPortã€CFMessagePort</p>
<p>â€”â€”â€”â€”å¼•è‡ªå­™æºrunLoopçº¿ä¸‹åˆ†äº«ä¼šè§†é¢‘ </p>
</blockquote>
<h3 id="NSTimeräº‹ä»¶æ˜¯å€ŸåŠ©runLoopå®ç°çš„ã€‚"><a href="#NSTimeräº‹ä»¶æ˜¯å€ŸåŠ©runLoopå®ç°çš„ã€‚" class="headerlink" title="NSTimeräº‹ä»¶æ˜¯å€ŸåŠ©runLoopå®ç°çš„ã€‚"></a>NSTimeräº‹ä»¶æ˜¯å€ŸåŠ©runLoopå®ç°çš„ã€‚</h3><p>è¿™ç‚¹è€å¸æœºæ—©åœ¨CoreAnimationç³»åˆ—ä¸­ç¬¬ä¸‰ç¯‡ä»‹ç»ä¸‰ä¸ªTimerçš„æ—¶å€™è€å¸æœºå°±æœ‰æåˆ°è¿‡ï¼Œåœ¨åˆå§‹åŒ–Timerçš„æ—¶å€™è¦å°†Timeræäº¤åˆ°runLoopä¸­ï¼Œå¹¶ä¸”è¦æŒ‡å®šmodeï¼Œæ‰å¯ä»¥å·¥ä½œã€‚ä»Šå¤©æˆ‘ä»¬å¯ä»¥æ·±å…¥è®²ä¸€ä¸‹ã€‚</p>
<blockquote>
<p>è¿™ä¸ªäº‹ä»¶æ˜¯æ€ä¹ˆæ‰§è¡Œçš„ï¼Ÿå¹¶ä¸”ä¸ºä»€ä¹ˆæœ‰çš„æ—¶å€™ä¼šå»¶è¿Ÿï¼Ÿä¸ºä»€ä¹ˆå­çº¿ç¨‹ä¸­åˆ›å»ºçš„Timerå¹¶ä¸æ‰§è¡Œï¼Ÿ</p>
<p>é¦–å…ˆï¼Œåœ¨è¿›å…¥å¾ªç¯å¼€å§‹ä»¥åï¼Œå°±è¦å¤„ç†source0äº‹ä»¶ï¼Œå¤„ç†åæ£€æµ‹ä¸€ä¸‹source1ç«¯å£æ˜¯å¦æœ‰æ¶ˆæ¯ï¼Œå¦‚æœä¸€ä¸ªTimerçš„æ—¶é—´é—´éš”åˆšå¥½åˆ°äº†åˆ™æ­¤å¤„æœ‰å¯èƒ½ä¼šå¾—åˆ°ä¸€ä¸ªæ¶ˆæ¯ï¼Œåˆ™runLoopç›´æ¥è·³è½¬è‡³ç«¯å£æ¿€æ´»å¤„ä»è€Œå»å¤„ç†Timeräº‹ä»¶ã€‚</p>
<p>ç¬¬äºŒï¼Œä¸ºä»€ä¹ˆä¼šå»¶è¿Ÿï¼Ÿæˆ‘ä»¬çŸ¥é“ï¼Œä¸¤æ¬¡ç«¯å£äº‹ä»¶æ˜¯åœ¨ä¸¤ä¸ªrunLoopå¾ªç¯ä¸­åˆ†åˆ«æ‰§è¡Œçš„ã€‚æ¯”å¦‚Timerçš„æ—¶é—´é—´éš”ä¸º1ç§’ï¼Œåœ¨ç¬¬ä¸€æ¬¡Timerå›è°ƒç»“æŸåï¼Œåœ¨å¾ˆçŸ­æ—¶é—´å†…ç«‹å³è¿›å…¥runLoopçš„ä¸‹ä¸€æ¬¡å¾ªç¯ï¼Œè¿™æ¬¡å¹¶ä¸æ˜¯Timerå›è°ƒå¹¶ä¸”æ˜¯ä¸€ä¸ªè®¡ç®—é‡éå¸¸å¤§çš„ä»»åŠ¡ï¼Œè®¡ç®—æ—¶é—´è¶…è¿‡äº†1ç§’ï¼Œé‚£ä¹ˆrunLoopçš„ç¬¬äºŒä¸ªå¾ªç¯å°±è¦æ‰§è¡Œå¾ˆä¹…ï¼Œæ— æ³•è¿›å…¥ä¸‹ä¸€ä¸ªå¾ªç¯ç­‰å¾…æœ‰å¯èƒ½å³å°†åˆ°æ¥çš„Timerç¬¬äºŒæ¬¡å›è°ƒçš„ä¿¡å·ï¼Œæ‰€ä»¥Timerç¬¬äºŒæ¬¡å›è°ƒå°±ä¼šæ¨è¿Ÿäº†ã€‚</p>
<p>ç¬¬ä¸‰ï¼Œä¸ºä»€ä¹ˆåœ¨å­çº¿ç¨‹ä¸­åˆ›å»ºçš„Timerå¹¶ä¸”æäº¤åˆ°å½“å‰runLoopä¸­å¹¶ä¸ä¼šè¿è¡Œï¼Ÿè¿™è¿˜æ˜¯è¦ä»runLoopçš„è·å–å‡½æ•°ä¸­çœ‹ï¼Œå½“è°ƒç”¨currentRunLoopçš„æ—¶å€™ä¼šå–å½“å‰çº¿ç¨‹å¯¹åº”çš„runLoopï¼Œè€Œé¦–æ¬¡æ˜¯å–ä¸åˆ°çš„ï¼Œåˆ™ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„runLoopã€‚ä½†æ˜¯ï¼è¿™ä¸ªrunLoopå¹¶æ²¡æœ‰runã€‚å°±æ˜¯æ²¡æœ‰å¼€å¯=ã€‚=</p>
</blockquote>
<hr>
<h3 id="åŒä¸€æ—¶é—´å†…ï¼ŒrunLoopåªèƒ½è¿è¡ŒåŒä¸€ç§modeã€‚é‚£commonModeæ˜¯æ€ä¹ˆå®ç°çš„ï¼Ÿ"><a href="#åŒä¸€æ—¶é—´å†…ï¼ŒrunLoopåªèƒ½è¿è¡ŒåŒä¸€ç§modeã€‚é‚£commonModeæ˜¯æ€ä¹ˆå®ç°çš„ï¼Ÿ" class="headerlink" title="åŒä¸€æ—¶é—´å†…ï¼ŒrunLoopåªèƒ½è¿è¡ŒåŒä¸€ç§modeã€‚é‚£commonModeæ˜¯æ€ä¹ˆå®ç°çš„ï¼Ÿ"></a>åŒä¸€æ—¶é—´å†…ï¼ŒrunLoopåªèƒ½è¿è¡ŒåŒä¸€ç§modeã€‚é‚£commonModeæ˜¯æ€ä¹ˆå®ç°çš„ï¼Ÿ</h3><p>ä»runLoopçš„ç»“æ„æˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼Œä¸€ä¸ªrunLoopä¼šåŒ…å«å¤šç§runLoopModeï¼ŒrunLoopæ˜¯ä¸åœçš„åœ¨è¿™äº›modeä¹‹é—´è¿›è¡Œåˆ‡æ¢å»å®Œæˆå¯¹åº”Modeä¸­çš„ç›¸å…³ä»»åŠ¡ã€‚</p>
<p><img src="http://upload-images.jianshu.io/upload_images/1835430-1a9ffd190ef7c73b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="runLoopä¸­å¤šä¸ªmode"></p>
<p>é¦–å…ˆä¸ºä»€ä¹ˆè¯´runLoopåªèƒ½åœ¨å„ç§Modeä¹‹é—´åˆ‡æ¢ï¼ŒåŒä¸€æ—¶é—´åªèƒ½å­˜åœ¨ä¸€ä¸ªå‘¢ï¼Ÿ<br>å› ä¸ºä¸Šé¢é‚£ä¸ªæ–¹æ³•å¿…é¡»è¦ä¼ ä¸€ä¸ªrunLoopModeï¼Œç„¶åè¿™ä¸ªæ–¹æ³•è´¯ç©¿å§‹ç»ˆï¼Œéƒ½åœ¨ç”¨ã€‚</p>
<p>æˆ‘ä»¬çœ‹åˆ°ï¼Œä¸Šé¢çš„æ–¹æ³•ä¸­é¦–å…ˆå°±è¦ä¼ å…¥ä¸€ä¸ªæŒ‡å®šçš„modeæ‰èƒ½æ‰§è¡Œå¯¹åº”modeä¸­çš„äº‹ä»¶ã€‚é‚£ä¹ˆæ‰€è°“çš„CommonModeæ˜¯å¦‚ä½•å®ç°çš„å‘¢ï¼Ÿ</p>
<p>æˆ‘ä»¬çœ‹åˆ°runLoopä¸­æ‰§è¡Œä»»åŠ¡æœ‰è°ƒåˆ°CFRunLoopDoBlocksè¿™ä¹ˆä¸€ä¸ªå‡½æ•°ï¼Œé‚£ä¹ˆè¿™ä¸ªå‡½æ•°æ˜¯ä»€ä¹ˆæ ·çš„å‘¢ï¼Ÿ</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">static Boolean __CFRunLoopDoBlocks(CFRunLoopRef rl, CFRunLoopModeRef rlm) &#123; // Call with rl and rlm locked</div><div class="line">    if (!rl-&gt;_blocks_head) return false;</div><div class="line">    if (!rlm || !rlm-&gt;_name) return false;</div><div class="line">    ...çœç•¥ä¸€äº›éé‡ç‚¹...</div><div class="line">    while (item) &#123;</div><div class="line">        struct _block_item *curr = item;</div><div class="line">        item = item-&gt;_next;</div><div class="line">	Boolean doit = false;</div><div class="line">	if (CFStringGetTypeID() == CFGetTypeID(curr-&gt;_mode)) &#123;</div><div class="line">	    doit = CFEqual(curr-&gt;_mode, curMode) || (CFEqual(curr-&gt;_mode, kCFRunLoopCommonModes) &amp;&amp; CFSetContainsValue(commonModes, curMode));</div><div class="line">        &#125; else &#123;</div><div class="line">	    doit = CFSetContainsValue((CFSetRef)curr-&gt;_mode, curMode) || (CFSetContainsValue((CFSetRef)curr-&gt;_mode, kCFRunLoopCommonModes) &amp;&amp; CFSetContainsValue(commonModes, curMode));</div><div class="line">	&#125;</div><div class="line">	if (!doit) prev = curr;</div><div class="line">	if (doit) &#123;</div><div class="line">	    if (prev) prev-&gt;_next = item;</div><div class="line">	    if (curr == head) head = item;</div><div class="line">	    if (curr == tail) tail = prev;</div><div class="line">	    void (^block)(void) = curr-&gt;_block;</div><div class="line">            CFRelease(curr-&gt;_mode);</div><div class="line">            free(curr);</div><div class="line">	    if (doit) &#123;</div><div class="line">                __CFRUNLOOP_IS_CALLING_OUT_TO_A_BLOCK__(block);</div><div class="line">	        did = true;</div><div class="line">	    &#125;</div><div class="line">    ...çœç•¥ä¸€äº›éé‡ç‚¹...</div><div class="line">    return did;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æˆ‘ä»¬çœ‹åˆ°<code>doit</code>è¿™ä¸ªboolå˜é‡å®Œå…¨å†³å®šäº†å½“å‰blockæ˜¯å¦æ‰§è¡Œã€‚é»˜è®¤ä»–æ˜¯Noçš„ï¼Œè€Œä»–è¢«ç½®ä¸ºtrueçš„æ¡ä»¶å°±æ˜¯<code>CFEqual(curr-&gt;_mode, curMode) || (CFEqual(curr-&gt;_mode, kCFRunLoopCommonModes) &amp;&amp; CFSetContainsValue(commonModes, curMode))</code>ã€‚å°±æ˜¯å½“å‰modeä¸åˆ¶å®šmodeç›¸ç­‰æˆ–è€…å½“å‰modeä¸ºcommonModeï¼ˆæ­¤å¤„ä¸ºä¸€ä¸ªå­—ç¬¦ä¸²ï¼‰ä¸”commonModeï¼ˆæ­¤å¤„ä¸ºä¸€ä¸ªé›†åˆï¼Œè‹¥æœ‰ä¸æ‡‚ï¼Œè¯·çœ‹runLoopç»“æ„ï¼‰è¿™ä¸ªé›†åˆä¸­åŒ…å«æŒ‡å®šmodeã€‚</p>
<p>è¿™æ˜¯å› ä¸ºè¿™ä¸ªåˆ¤æ–­çš„å­˜åœ¨æ‰å…è®¸commondModeå¯ä»¥åœ¨ä»»æ„Modeä¸‹æ‰§è¡Œã€‚<br>å½“ç„¶è¿™æ˜¯æäº¤åˆ°runLoopé‡Œçš„ä»£ç å—æ‰ä¼šèµ°åˆ°<code>__CFRunLoopDoBlocks</code>è¿™ä¸ªæ–¹æ³•ã€‚</p>
<p>ç›¸åŒçš„ï¼Œæˆ‘ä»¬é€šè¿‡ä¸Šè¿°ä»£ç ä¹Ÿå¯ä»¥çŸ¥é“ï¼ŒrunLoopé€šè¿‡ç«¯å£å”¤é†’çš„äº‹ä»¶éœ€è¦é€šè¿‡<strong>CFRunLoopDoSource1å’Œ</strong>CFRunLoopDoTimersä¸¤ä¸ªæ–¹æ³•æ¥è°ƒç”¨ã€‚__CFRunLoopDoSource1æ–¹æ³•æ²¡ä»€ä¹ˆè¯´çš„ï¼Œç›´æ¥è°ƒç”¨æºäº‹ä»¶runLoopSourceRefå³å¯ã€‚é‡ç‚¹æˆ‘ä»¬çœ‹ä¸€ä¸‹Timerçš„å®ç°ï¼Œæ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">static Boolean __CFRunLoopDoTimers(CFRunLoopRef rl, CFRunLoopModeRef rlm, uint64_t limitTSR) &#123;	/* DOES CALLOUT */</div><div class="line">    Boolean timerHandled = false;</div><div class="line">    CFMutableArrayRef timers = NULL;</div><div class="line">    //éå†runLoopModeç»´æŠ¤çš„Timersæ•°ç»„ï¼Œå–å…¶ä¸­æœ‰æ•ˆçš„timerå¹¶åŠ å…¥æ–°ä¸´æ—¶æ•°ç»„</div><div class="line">    for (CFIndex idx = 0, cnt = rlm-&gt;_timers ? CFArrayGetCount(rlm-&gt;_timers) : 0; idx &lt; cnt; idx++) &#123;</div><div class="line">        CFRunLoopTimerRef rlt = (CFRunLoopTimerRef)CFArrayGetValueAtIndex(rlm-&gt;_timers, idx);</div><div class="line">        </div><div class="line">        if (__CFIsValid(rlt) &amp;&amp; !__CFRunLoopTimerIsFiring(rlt)) &#123;</div><div class="line">            if (rlt-&gt;_fireTSR &lt;= limitTSR) &#123;</div><div class="line">                if (!timers) timers = CFArrayCreateMutable(kCFAllocatorSystemDefault, 0, &amp;kCFTypeArrayCallBacks);</div><div class="line">                CFArrayAppendValue(timers, rlt);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    //éå†ä¸´æ—¶æ•°ç»„ï¼Œæ¯ä¸ªæœ‰æ•ˆTimerè°ƒç”¨__CFRunLoopDoTimer</div><div class="line">    for (CFIndex idx = 0, cnt = timers ? CFArrayGetCount(timers) : 0; idx &lt; cnt; idx++) &#123;</div><div class="line">        CFRunLoopTimerRef rlt = (CFRunLoopTimerRef)CFArrayGetValueAtIndex(timers, idx);</div><div class="line">        Boolean did = __CFRunLoopDoTimer(rl, rlm, rlt);</div><div class="line">        timerHandled = timerHandled || did;</div><div class="line">    &#125;</div><div class="line">    if (timers) CFRelease(timers);</div><div class="line">    return timerHandled;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œæ­¤å¤„Timeræ˜¯å¦ä¼šå›è°ƒå®Œå…¨å–å†³äºå¯¹åº”Modeçš„_Timersæ•°ç»„ã€‚é‚£ä¹ˆå½“æˆ‘ä»¬å°†TimeråŠ å…¥åˆ°commonModesä¸­çš„æ—¶å€™ä¸€å®šæ˜¯åŒæ—¶å°†TimeråŠ å…¥åˆ°äº†commonModesæ‰€åŒ…å«çš„å…¶ä»–Modeä¸­äº†ï¼Œæˆ‘ä»¬çœ‹ä¸‹ä»£ç ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div></pre></td><td class="code"><pre><div class="line">void CFRunLoopAddTimer(CFRunLoopRef rl, CFRunLoopTimerRef rlt, CFStringRef modeName) &#123;    </div><div class="line">    CHECK_FOR_FORK();</div><div class="line">    if (__CFRunLoopIsDeallocating(rl)) return;</div><div class="line">    if (!__CFIsValid(rlt) || (NULL != rlt-&gt;_runLoop &amp;&amp; rlt-&gt;_runLoop != rl)) return;</div><div class="line">    __CFRunLoopLock(rl);</div><div class="line">    if (modeName == kCFRunLoopCommonModes) &#123;//commonModesåˆ†æ”¯</div><div class="line">    	//å–åˆ°commonModesæ‰€ä»£è¡¨çš„Modeçš„é›†åˆ</div><div class="line">        CFSetRef set = rl-&gt;_commonModes ? CFSetCreateCopy(kCFAllocatorSystemDefault, rl-&gt;_commonModes) : NULL;</div><div class="line">        if (NULL == rl-&gt;_commonModeItems) &#123;</div><div class="line">        	//å°†commonModeItemsä¸­åŠ å…¥å½“å‰å®šæ—¶å™¨</div><div class="line">            rl-&gt;_commonModeItems = CFSetCreateMutable(kCFAllocatorSystemDefault, 0, &amp;kCFTypeSetCallBacks);</div><div class="line">        &#125;</div><div class="line">        CFSetAddValue(rl-&gt;_commonModeItems, rlt);</div><div class="line">        if (NULL != set) &#123;</div><div class="line">            CFTypeRef context[2] = &#123;rl, rlt&#125;;</div><div class="line">            /* add new item to all common-modes */</div><div class="line">            //æœ€ä¸»è¦è¿˜æ˜¯è¿˜æ˜¯è¿™å¥ï¼Œè¿™å¥çš„ä½œç”¨æ˜¯é›†åˆä¸­çš„æ‰€æœ‰å¯¹è±¡å‡è°ƒç”¨__CFRunLoopAddItemToCommonModesè¿™ä¸ªæ–¹æ³•ã€‚</div><div class="line">            CFSetApplyFunction(set, (__CFRunLoopAddItemToCommonModes), (void *)context);</div><div class="line">            CFRelease(set);</div><div class="line">        &#125;</div><div class="line">    &#125; else &#123;//écommonModesçš„åˆ†æ”¯</div><div class="line">        CFRunLoopModeRef rlm = __CFRunLoopFindMode(rl, modeName, true);</div><div class="line">        if (NULL != rlm) &#123;</div><div class="line">            if (NULL == rlm-&gt;_timers) &#123;</div><div class="line">                CFArrayCallBacks cb = kCFTypeArrayCallBacks;</div><div class="line">                cb.equal = NULL;</div><div class="line">                rlm-&gt;_timers = CFArrayCreateMutable(kCFAllocatorSystemDefault, 0, &amp;cb);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        if (NULL != rlm &amp;&amp; !CFSetContainsValue(rlt-&gt;_rlModes, rlm-&gt;_name)) &#123;</div><div class="line">            __CFRunLoopTimerLock(rlt);</div><div class="line">            if (NULL == rlt-&gt;_runLoop) &#123;</div><div class="line">                rlt-&gt;_runLoop = rl;</div><div class="line">            &#125; else if (rl != rlt-&gt;_runLoop) &#123;</div><div class="line">                __CFRunLoopTimerUnlock(rlt);</div><div class="line">                __CFRunLoopModeUnlock(rlm);</div><div class="line">                __CFRunLoopUnlock(rl);</div><div class="line">                return;</div><div class="line">            &#125;</div><div class="line">            CFSetAddValue(rlt-&gt;_rlModes, rlm-&gt;_name);</div><div class="line">            __CFRunLoopTimerUnlock(rlt);</div><div class="line">            __CFRunLoopTimerFireTSRLock();</div><div class="line">            __CFRepositionTimerInMode(rlm, rlt, false);</div><div class="line">            __CFRunLoopTimerFireTSRUnlock();</div><div class="line">            if (!_CFExecutableLinkedOnOrAfter(CFSystemVersionLion)) &#123;</div><div class="line">                // Normally we don&apos;t do this on behalf of clients, but for</div><div class="line">                // backwards compatibility due to the change in timer handling...</div><div class="line">                if (rl != CFRunLoopGetCurrent()) CFRunLoopWakeUp(rl);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        if (NULL != rlm) &#123;</div><div class="line">            __CFRunLoopModeUnlock(rlm);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    __CFRunLoopUnlock(rl);</div><div class="line">&#125;</div><div class="line"></div><div class="line">static void __CFRunLoopAddItemToCommonModes(const void *value, void *ctx) &#123;</div><div class="line">    CFStringRef modeName = (CFStringRef)value;</div><div class="line">    CFRunLoopRef rl = (CFRunLoopRef)(((CFTypeRef *)ctx)[0]);</div><div class="line">    CFTypeRef item = (CFTypeRef)(((CFTypeRef *)ctx)[1]);</div><div class="line">    if (CFGetTypeID(item) == __kCFRunLoopSourceTypeID) &#123;</div><div class="line">	CFRunLoopAddSource(rl, (CFRunLoopSourceRef)item, modeName);</div><div class="line">    &#125; else if (CFGetTypeID(item) == __kCFRunLoopObserverTypeID) &#123;</div><div class="line">	CFRunLoopAddObserver(rl, (CFRunLoopObserverRef)item, modeName);</div><div class="line">    &#125; else if (CFGetTypeID(item) == __kCFRunLoopTimerTypeID) &#123;</div><div class="line">	CFRunLoopAddTimer(rl, (CFRunLoopTimerRef)item, modeName);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œå½“åŠ å…¥åˆ°commonModesä¸­æ—¶ï¼Œå®é™…ä¸Šç³»ç»Ÿæ˜¯<code>æ‰¾å‡ºcommonModesä»£è¡¨çš„æ‰€æœ‰Mode</code>ï¼Œå¦‚defaultModeå’ŒtrackingModeï¼Œè®©ååˆ†åˆ«å°†å…¶åŠ å…¥äº†è¿™äº›modeä¸­ã€‚<br>åŒæ ·çš„æ–¹æ³•è¿˜æœ‰<code>CFRunLoopAddSource</code>/<code>CFRunLoopAddObserver</code>éƒ½æ˜¯åŒæ ·çš„é“ç†ã€‚</p>
<p>æ‰€ä»¥è¯´å½“scrollViewæˆ–å…¶å­ç±»è¿›è¡Œæ»šåŠ¨çš„æ—¶å€™ï¼ŒUIKITä¼šè‡ªåŠ¨å°†å½“å‰runLoopModeåˆ‡æ¢ä¸ºUITrackingRunLoopModeï¼Œæ‰€ä»¥ä½ åŠ åœ¨defaultModeä¸­çš„è®¡æ—¶å™¨å½“ç„¶ä¸ä¼šèµ°äº†ã€‚</p>
<hr>
<h3 id="runLoopæ˜¯å¦‚ä½•ä¼‘çœ æœ‰å¦‚ä½•è¢«å”¤é†’çš„ï¼Ÿ"><a href="#runLoopæ˜¯å¦‚ä½•ä¼‘çœ æœ‰å¦‚ä½•è¢«å”¤é†’çš„ï¼Ÿ" class="headerlink" title="runLoopæ˜¯å¦‚ä½•ä¼‘çœ æœ‰å¦‚ä½•è¢«å”¤é†’çš„ï¼Ÿ"></a>runLoopæ˜¯å¦‚ä½•ä¼‘çœ æœ‰å¦‚ä½•è¢«å”¤é†’çš„ï¼Ÿ</h3><p>ä»ç¬¬7æ­¥å¼€å§‹ï¼Œæˆ‘ä»¬çœ‹åˆ°runLoopè¿›å…¥äº†ä¼‘çœ çŠ¶æ€ã€‚ç„¶è€Œæ‰€è°“çš„ä¼‘çœ çŠ¶æ€æŒ‡ç¤ºå°†å½“å‰runLoopæ ‡è®°ä¸ºä¼‘çœ ä¹‹åï¼Œ<strong>è¿›å…¥äº†ä¸€ä¸ªwhileæ­»å¾ªç¯</strong>ã€‚ç„¶ååœ¨å¾ªç¯å†…å°±ä¸æ–­çš„å»è¯»å–ç«¯å£æ¶ˆæ¯ã€‚å¦‚æœè¯´ä»ç«¯å£ä¸­<strong>è¯»å–åˆ°ä¸€ä¸ªå”¤é†’ä¿¡æ¯çš„è¯ï¼Œbreakæ‰whileå¾ªç¯ä»è€Œè¿›å…¥å”¤é†’çŠ¶æ€</strong>ã€‚</p>
<p>å…³äºrunLoopçš„å‡ ç§modeè€å¸æœºä¹‹å‰ä¹Ÿæœ‰è®²è¿‡ï¼Œåœ¨CoreAnimationä¸­çš„ç¬¬ä¸‰ç¯‡ä¸­æœ‰è®²åˆ°ï¼Œè¿™é‡Œå°±åªç½—åˆ—ä¸€ä¸‹ã€‚</p>
<ul>
<li>NSDefaultRunLoopMode</li>
<li>NSConnectionReplyMode</li>
<li>NSModalPanelRunLoopMode</li>
<li>UITrackingRunLoopMode</li>
<li>NSRunLoopCommonModes</li>
</ul>
<hr>
<h3 id="å¯ä»¥å”¤é†’runLoopçš„éƒ½æœ‰å“ªäº›äº‹ä»¶ï¼Ÿ"><a href="#å¯ä»¥å”¤é†’runLoopçš„éƒ½æœ‰å“ªäº›äº‹ä»¶ï¼Ÿ" class="headerlink" title="å¯ä»¥å”¤é†’runLoopçš„éƒ½æœ‰å“ªäº›äº‹ä»¶ï¼Ÿ"></a>å¯ä»¥å”¤é†’runLoopçš„éƒ½æœ‰å“ªäº›äº‹ä»¶ï¼Ÿ</h3><p>ä»æºç ä¸­æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œæ‰€è°“çš„runLoopè¿›å…¥ä¼‘çœ çŠ¶æ€ä¸è¿‡æ˜¯ä¸€ä¸ªwhileå¾ªç¯ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">do &#123;</div><div class="line">            if (kCFUseCollectableAllocator) &#123;</div><div class="line">                objc_clear_stack(0);</div><div class="line">                memset(msg_buffer, 0, sizeof(msg_buffer));</div><div class="line">            &#125;</div><div class="line">            msg = (mach_msg_header_t *)msg_buffer;</div><div class="line">            __CFRunLoopServiceMachPort(waitSet, &amp;msg, sizeof(msg_buffer), &amp;livePort, poll ? 0 : TIMEOUT_INFINITY);</div><div class="line">            </div><div class="line">            if (modeQueuePort != MACH_PORT_NULL &amp;&amp; livePort == modeQueuePort) &#123;</div><div class="line">                // Drain the internal queue. If one of the callout blocks sets the timerFired flag, break out and service the timer.</div><div class="line">                while (_dispatch_runloop_root_queue_perform_4CF(rlm-&gt;_queue));</div><div class="line">                if (rlm-&gt;_timerFired) &#123;</div><div class="line">                    // Leave livePort as the queue port, and service timers below</div><div class="line">                    rlm-&gt;_timerFired = false;</div><div class="line">                    break;</div><div class="line">                &#125; else &#123;</div><div class="line">                    if (msg &amp;&amp; msg != (mach_msg_header_t *)msg_buffer) free(msg);</div><div class="line">                &#125;</div><div class="line">            &#125; else &#123;</div><div class="line">                // Go ahead and leave the inner loop.</div><div class="line">                break;</div><div class="line">            &#125;</div><div class="line"> &#125; while (1);</div></pre></td></tr></table></figure>
<p>ç›¸åº”çš„æˆ‘ä»¬è¿˜å¾—çœ‹ä¸€ä¸ªå‡½æ•°ï¼Œ<code>__CFRunLoopServiceMachPort</code>ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">static Boolean __CFRunLoopServiceMachPort(mach_port_name_t port, mach_msg_header_t**buffer, size_t buffer_size, mach_port_t *livePort, mach_msg_timeout_t timeout) &#123;</div><div class="line">    Boolean originalBuffer = true;</div><div class="line">    kern_return_t ret = KERN_SUCCESS;</div><div class="line">    for (;;) &#123;		/* In that sleep of death what nightmares may come ... */</div><div class="line">        mach_msg_header_t *msg = (mach_msg_header_t *)*buffer;</div><div class="line">        msg-&gt;msgh_bits = 0;</div><div class="line">        msg-&gt;msgh_local_port = port;</div><div class="line">        msg-&gt;msgh_remote_port = MACH_PORT_NULL;</div><div class="line">        msg-&gt;msgh_size = buffer_size;</div><div class="line">        msg-&gt;msgh_id = 0;</div><div class="line">        if (TIMEOUT_INFINITY == timeout) &#123; CFRUNLOOP_SLEEP(); &#125; else &#123; CFRUNLOOP_POLL(); &#125;</div><div class="line">        ret = mach_msg(msg, MACH_RCV_MSG|MACH_RCV_LARGE|((TIMEOUT_INFINITY != timeout) ? MACH_RCV_TIMEOUT : 0)|MACH_RCV_TRAILER_TYPE(MACH_MSG_TRAILER_FORMAT_0)|MACH_RCV_TRAILER_ELEMENTS(MACH_RCV_TRAILER_AV), 0, msg-&gt;msgh_size, port, timeout, MACH_PORT_NULL);</div><div class="line">        CFRUNLOOP_WAKEUP(ret);</div><div class="line">        if (MACH_MSG_SUCCESS == ret) &#123;</div><div class="line">            *livePort = msg ? msg-&gt;msgh_local_port : MACH_PORT_NULL;</div><div class="line">            return true;</div><div class="line">        &#125;</div><div class="line">        if (MACH_RCV_TIMED_OUT == ret) &#123;</div><div class="line">            if (!originalBuffer) free(msg);</div><div class="line">            *buffer = NULL;</div><div class="line">            *livePort = MACH_PORT_NULL;</div><div class="line">            return false;</div><div class="line">        &#125;</div><div class="line">        if (MACH_RCV_TOO_LARGE != ret) break;</div><div class="line">        buffer_size = round_msg(msg-&gt;msgh_size + MAX_TRAILER_SIZE);</div><div class="line">        if (originalBuffer) *buffer = NULL;</div><div class="line">        originalBuffer = false;</div><div class="line">        *buffer = realloc(*buffer, buffer_size);</div><div class="line">    &#125;</div><div class="line">    HALT;</div><div class="line">    return false;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æˆ‘ä»¬å…ˆçœ‹åé¢è¿™ä¸ªå‡½æ•°ï¼Œåœ¨è¿™é‡Œä»…æœ‰<code>ä¸¤ç§æƒ…å†µä¼šå¯¹livePortè¿›è¡Œèµ‹å€¼</code>ï¼Œä¸€ç§æ˜¯<strong>æˆåŠŸè·å–åˆ°æ¶ˆæ¯å</strong>ï¼Œä¼šæ ¹æ®æƒ…å†µèµ‹å€¼ä¸ºmsg-&gt;msgh_local_portæˆ–è€…MACH_PORT_NULLï¼Œè€Œå¦ä¸€ç§<strong>è·å–æ¶ˆæ¯è¶…æ—¶</strong>çš„æƒ…å†µä¼šèµ‹å€¼ä¸ºMACH_PORT_NULLã€‚é¦–å…ˆè¯·å…ˆè®°ä½è¿™ä¸¤ä¸ªç»“è®ºã€‚</p>
<p>ç„¶åæˆ‘ä»¬æŠŠç›®å…‰èšç„¦åˆ°whileå¾ªç¯ä¸­ï¼Œåœ¨è°ƒç”¨<code>__CFRunLoopServiceMachPort</code>åå¦‚æœlivePortå˜æˆäº†<code>modeQueuePort</code>(livePortåˆå€¼ä¸ºMACH_PORT_NULL)ï¼Œåˆ™ä»£è¡¨ä¸ºå½“å‰é˜Ÿåˆ—çš„æ£€æµ‹ç«¯å£ï¼Œé‚£ä¹ˆåœ¨<code>_dispatch_runloop_root_queue_perform_4CF</code>çš„æ¡ä»¶ä¸‹å†æ¬¡è¿›å…¥äºŒçº§å¾ªç¯ï¼ŒçŸ¥é“Timerè¢«æ¿€æ´»äº†æ‰è·³å‡ºäºŒçº§å¾ªç¯ç»§ç»­å¾ªç¯ä¸€çº§å¾ªç¯ã€‚ï¼ˆè¿™ä¸€æ­¥çš„ç›®çš„ä¸å¥½æ„æ€è€å¸æœºçœŸæ²¡çœ‹æ‡‚ï¼‰ã€‚</p>
<p>é‚£ä¹ˆå¦‚æœlivePortä¸ä¸ºmodeQueuePortæ—¶æˆ‘ä»¬çš„runLoopè¢«å”¤é†’ã€‚è¿™ä»£è¡¨__CFRunLoopServiceMachPortç»™å‡ºçš„livePortåªæœ‰ä¸¤ç§å¯èƒ½ï¼š<code>ä¸€ç§æƒ…å†µä¸ºMACH_PORT_NULLï¼Œå¦ä¸€ç§ä¸ºçœŸæ­£è·å–çš„æ¶ˆæ¯çš„ç«¯å£</code>ã€‚</p>
<p>æ‰€ä»¥æˆ‘ä»¬å¯ä»¥çœ‹åˆ°åé¢runLoopå¤„ç†ç«¯å£æ—¶é—´çš„æ–¹æ³•å¦‚ä¸‹çš„åˆ¤æ–­ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">        if (MACH_PORT_NULL == livePort) &#123;//ä»€ä¹ˆéƒ½ä¸åšï¼Œæœ‰è‚¯èƒ½æ˜¯è¶…æ—¶ä¹‹ç±»çš„æˆ–è€…æ˜¯ä¿¡æ¯è¿‡å¤§</div><div class="line">            CFRUNLOOP_WAKEUP_FOR_NOTHING();</div><div class="line">            // handle nothing</div><div class="line">        &#125; else if (livePort == rl-&gt;_wakeUpPort) &#123;//åªæœ‰å¤–ç•Œè°ƒç”¨CFRunLoopWakeUpæ‰ä¼šè¿›å…¥æ­¤åˆ†æ”¯ï¼Œè¿™æ˜¯å¤–éƒ¨ä¸»åŠ¨å”¤é†’runLoopçš„æ¥å£</div><div class="line">            CFRUNLOOP_WAKEUP_FOR_WAKEUP();</div><div class="line">            // do nothing on Mac OS</div><div class="line">        &#125;</div><div class="line">#if USE_DISPATCH_SOURCE_FOR_TIMERS</div><div class="line">        else if (modeQueuePort != MACH_PORT_NULL &amp;&amp; livePort == modeQueuePort) &#123;//è¿™é‡Œä¸æ˜¯ä»runLoopä¼‘çœ åå”¤é†’åˆ°è¿™é‡Œçš„ï¼Œè€Œæ˜¯åœ¨runLoop10æ­¥ä¸­çš„ç¬¬äº”æ­¥è·³è½¬è¿‡æ¥çš„ï¼Œæ˜¯å¤„ç†è®¡æ—¶å™¨äº‹ä»¶</div><div class="line">            CFRUNLOOP_WAKEUP_FOR_TIMER();</div><div class="line">            ...çœç•¥å¤„ç†è®¡æ—¶å™¨äº‹ä»¶çš„ä»£ç ...</div><div class="line">        &#125;</div><div class="line">#endif</div><div class="line">        else if (livePort == dispatchPort) &#123;//è¿™é‡Œæ˜¯å¤„ç†GCDæäº¤åˆ°mainQueueçš„blockçš„ç«¯å£äº‹ä»¶</div><div class="line">            CFRUNLOOP_WAKEUP_FOR_DISPATCH();</div><div class="line">            ...çœç•¥å¤„ç†GCDçš„ä»£ç ...</div><div class="line">        &#125; else &#123;//ä¹‹å‰æ‰€æœ‰æƒ…å†µéƒ½ä¸æ˜¯ï¼Œé‚£ä¹ˆå”¤é†’runLoopçš„å°±åªå¯èƒ½æ˜¯source1çš„æºäº‹ä»¶äº†ã€‚</div><div class="line">            CFRUNLOOP_WAKEUP_FOR_SOURCE();</div><div class="line">            ...çœç•¥å¤„ç†source1æºäº‹ä»¶çš„ä»£ç ...</div><div class="line">            &#125;</div><div class="line">        &#125;</div></pre></td></tr></table></figure>
<p><code>runLoopçš„å”¤é†’è¿‡ç¨‹ï¼ŒåŠå”¤é†’è¿‡åçš„æ—¶é—´å¤„ç†å°±æ˜¯ä¸Šé¢çš„æµç¨‹</code>ï¼Œå¤§å®¶å¯ä»¥çœ‹çœ‹æ¯ä¸ªåˆ†æ”¯åçš„æ³¨é‡Šã€‚åŒæ—¶runLoopRunçš„æ ¸å¿ƒä»£ç ä¹Ÿå°±è§£è¯»å®Œæ¯•äº†ã€‚</p>
<p>å‰©ä¸‹çš„å‡ ä¸ªrunæ–¹æ³•äº‹å®ä¸Šéƒ½æ˜¯å¯¹è¿™ä¸ªæ ¸å¿ƒæ–¹æ³•çš„å°è£…äº†è€å¸æœºä¸éƒ½è¯´äº†ï¼š</p>
<ul>
<li>CFRunLoopRunSpecific</li>
<li>CFRunLoopRun</li>
<li>CFRunLoopRunInMode</li>
</ul>
<p>è‡³æ­¤ï¼Œæ•´ä¸ªrunLoopä¸­çš„æ ¸å¿ƒæµç¨‹è€å¸æœºä¹Ÿç®—å¸¦ç€å¤§å®¶åˆ†æäº†ä¸€é~</p>
<p><img src="http://upload-images.jianshu.io/upload_images/1835430-c01c74630903d263.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="å–˜ä¸€å£æ°”"></p>
<hr>
<h1 id="runLoopéƒ½èƒ½åšä»€ä¹ˆ"><a href="#runLoopéƒ½èƒ½åšä»€ä¹ˆ" class="headerlink" title="runLoopéƒ½èƒ½åšä»€ä¹ˆ"></a>runLoopéƒ½èƒ½åšä»€ä¹ˆ</h1><p>è¯´äº†è¿™ä¹ˆå¤šï¼Œé‚£ä¹ˆrunLoopéƒ½èƒ½åšäº›ä»€ä¹ˆå‘¢?</p>
<p>ä»¥ä¸‹å†…å®¹æ•´ç†è‡ª<a href="http://blog.ibireme.com/2015/05/18/runloop/" target="_blank" rel="external">æ·±å…¥ç†è§£RunLoop
</a>ã€å­™æºrunLoopçº¿ä¸‹åˆ†äº«ä¼šè§†é¢‘ï¼š</p>
<h2 id="AutoReleasePoolï¼š"><a href="#AutoReleasePoolï¼š" class="headerlink" title="AutoReleasePoolï¼š"></a>AutoReleasePoolï¼š</h2><blockquote>
<p>Appå¯åŠ¨åï¼Œè‹¹æœåœ¨ä¸»çº¿ç¨‹ RunLoop é‡Œæ³¨å†Œäº†ä¸¤ä¸ª Observerï¼Œå…¶å›è°ƒéƒ½æ˜¯ _wrapRunLoopWithAutoreleasePoolHandler()ã€‚</p>
<p>ç¬¬ä¸€ä¸ª Observer ç›‘è§†çš„äº‹ä»¶æ˜¯ Entry(å³å°†è¿›å…¥Loop)ï¼Œå…¶å›è°ƒå†…ä¼šè°ƒç”¨ _objc_autoreleasePoolPush() åˆ›å»ºè‡ªåŠ¨é‡Šæ”¾æ± ã€‚å…¶ order æ˜¯-2147483647ï¼Œä¼˜å…ˆçº§æœ€é«˜ï¼Œä¿è¯åˆ›å»ºé‡Šæ”¾æ± å‘ç”Ÿåœ¨å…¶ä»–æ‰€æœ‰å›è°ƒä¹‹å‰ã€‚</p>
<p>ç¬¬äºŒä¸ª Observer ç›‘è§†äº†ä¸¤ä¸ªäº‹ä»¶ï¼š BeforeWaiting(å‡†å¤‡è¿›å…¥ä¼‘çœ ) æ—¶è°ƒç”¨_objc_autoreleasePoolPop() å’Œ _objc_autoreleasePoolPush() é‡Šæ”¾æ—§çš„æ± å¹¶åˆ›å»ºæ–°æ± ï¼›Exit(å³å°†é€€å‡ºLoop) æ—¶è°ƒç”¨ _objc_autoreleasePoolPop() æ¥é‡Šæ”¾è‡ªåŠ¨é‡Šæ”¾æ± ã€‚è¿™ä¸ª Observer çš„ order æ˜¯ 2147483647ï¼Œä¼˜å…ˆçº§æœ€ä½ï¼Œä¿è¯å…¶é‡Šæ”¾æ± å­å‘ç”Ÿåœ¨å…¶ä»–æ‰€æœ‰å›è°ƒä¹‹åã€‚</p>
<p>åœ¨ä¸»çº¿ç¨‹æ‰§è¡Œçš„ä»£ç ï¼Œé€šå¸¸æ˜¯å†™åœ¨è¯¸å¦‚äº‹ä»¶å›è°ƒã€Timerå›è°ƒå†…çš„ã€‚è¿™äº›å›è°ƒä¼šè¢« RunLoop åˆ›å»ºå¥½çš„ AutoreleasePool ç¯ç»•ç€ï¼Œæ‰€ä»¥ä¸ä¼šå‡ºç°å†…å­˜æ³„æ¼ï¼Œå¼€å‘è€…ä¹Ÿä¸å¿…æ˜¾ç¤ºåˆ›å»º Pool äº†ã€‚</p>
</blockquote>
<h2 id="CAAnimation"><a href="#CAAnimation" class="headerlink" title="CAAnimation"></a>CAAnimation</h2><p>æˆ‘ä»¬çŸ¥é“CAAniamtionä¸ºæˆ‘ä»¬æä¾›çš„æ˜¯<code>è¡¥é—´åŠ¨ç”»</code>ï¼Œå¼€å‘è€…åªè¦ç»™å‡ºå§‹æœ«çŠ¶æ€åä¸­é—´çŠ¶æ€æœ‰ç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆã€‚é‚£ä¹ˆåŠ¨ç”»æ˜¯æ€ä¹ˆå‡ºç°çš„å‘¢ï¼Œæ˜¯å¼€å‘è€…ç»™å‡ºå§‹æœ«çŠ¶æ€åï¼Œ<code>ç³»ç»Ÿè®¡ç®—å‡ºæ¯ä¸€ä¸ªä¸­é—´æ€çš„å„é¡¹å‚æ•°</code>ï¼Œ<code>ç„¶åå¯ä¸€ä¸ªå®šæ—¶å™¨ä¸æ–­å»å›è°ƒå¹¶æ”¹å˜å±æ€§</code>ã€‚</p>
<h2 id="äº‹ä»¶å“åº”"><a href="#äº‹ä»¶å“åº”" class="headerlink" title="äº‹ä»¶å“åº”"></a>äº‹ä»¶å“åº”</h2><blockquote>
<p>è‹¹æœæ³¨å†Œäº†ä¸€ä¸ª Source1 (åŸºäº mach port çš„) ç”¨æ¥æ¥æ”¶ç³»ç»Ÿäº‹ä»¶ï¼Œå…¶å›è°ƒå‡½æ•°ä¸º __IOHIDEventSystemClientQueueCallback()ã€‚</p>
<p>å½“ä¸€ä¸ªç¡¬ä»¶äº‹ä»¶(è§¦æ‘¸/é”å±/æ‘‡æ™ƒç­‰)å‘ç”Ÿåï¼Œé¦–å…ˆç”± IOKit.framework ç”Ÿæˆä¸€ä¸ª IOHIDEvent äº‹ä»¶å¹¶ç”± SpringBoard æ¥æ”¶ã€‚è¿™ä¸ªè¿‡ç¨‹çš„è¯¦ç»†æƒ…å†µå¯ä»¥å‚è€ƒè¿™é‡Œã€‚SpringBoard åªæ¥æ”¶æŒ‰é”®(é”å±/é™éŸ³ç­‰)ï¼Œè§¦æ‘¸ï¼ŒåŠ é€Ÿï¼Œæ¥è¿‘ä¼ æ„Ÿå™¨ç­‰å‡ ç§ Eventï¼Œéšåç”¨ mach port è½¬å‘ç»™éœ€è¦çš„Appè¿›ç¨‹ã€‚éšåè‹¹æœæ³¨å†Œçš„é‚£ä¸ª Source1 å°±ä¼šè§¦å‘å›è°ƒï¼Œå¹¶è°ƒç”¨ _UIApplicationHandleEventQueue() è¿›è¡Œåº”ç”¨å†…éƒ¨çš„åˆ†å‘ã€‚</p>
<p>_UIApplicationHandleEventQueue() ä¼šæŠŠ IOHIDEvent å¤„ç†å¹¶åŒ…è£…æˆ UIEvent è¿›è¡Œå¤„ç†æˆ–åˆ†å‘ï¼Œå…¶ä¸­åŒ…æ‹¬è¯†åˆ« UIGesture/å¤„ç†å±å¹•æ—‹è½¬/å‘é€ç»™ UIWindow ç­‰ã€‚é€šå¸¸äº‹ä»¶æ¯”å¦‚ UIButton ç‚¹å‡»ã€touchesBegin/Move/End/Cancel äº‹ä»¶éƒ½æ˜¯åœ¨è¿™ä¸ªå›è°ƒä¸­å®Œæˆçš„ã€‚</p>
</blockquote>
<h2 id="æ‰‹åŠ¿è¯†åˆ«"><a href="#æ‰‹åŠ¿è¯†åˆ«" class="headerlink" title="æ‰‹åŠ¿è¯†åˆ«"></a>æ‰‹åŠ¿è¯†åˆ«</h2><blockquote>
<p>å½“ä¸Šé¢çš„ _UIApplicationHandleEventQueue() è¯†åˆ«äº†ä¸€ä¸ªæ‰‹åŠ¿æ—¶ï¼Œå…¶é¦–å…ˆä¼šè°ƒç”¨ Cancel å°†å½“å‰çš„ touchesBegin/Move/End ç³»åˆ—å›è°ƒæ‰“æ–­ã€‚éšåç³»ç»Ÿå°†å¯¹åº”çš„ UIGestureRecognizer æ ‡è®°ä¸ºå¾…å¤„ç†ã€‚</p>
<p>è‹¹æœæ³¨å†Œäº†ä¸€ä¸ª Observer ç›‘æµ‹ BeforeWaiting (Loopå³å°†è¿›å…¥ä¼‘çœ ) äº‹ä»¶ï¼Œè¿™ä¸ªObserverçš„å›è°ƒå‡½æ•°æ˜¯ _UIGestureRecognizerUpdateObserver()ï¼Œå…¶å†…éƒ¨ä¼šè·å–æ‰€æœ‰åˆšè¢«æ ‡è®°ä¸ºå¾…å¤„ç†çš„ GestureRecognizerï¼Œå¹¶æ‰§è¡ŒGestureRecognizerçš„å›è°ƒã€‚</p>
<p>å½“æœ‰ UIGestureRecognizer çš„å˜åŒ–(åˆ›å»º/é”€æ¯/çŠ¶æ€æ”¹å˜)æ—¶ï¼Œè¿™ä¸ªå›è°ƒéƒ½ä¼šè¿›è¡Œç›¸åº”å¤„ç†ã€‚</p>
</blockquote>
<h2 id="å®šæ—¶å™¨"><a href="#å®šæ—¶å™¨" class="headerlink" title="å®šæ—¶å™¨"></a>å®šæ—¶å™¨</h2><p>ä¸å¤šè¯´äº†è¿™ä¸ªå°±ã€‚</p>
<h2 id="PerformSelecter"><a href="#PerformSelecter" class="headerlink" title="PerformSelecter"></a>PerformSelecter</h2><blockquote>
<p>å½“è°ƒç”¨ NSObject çš„ performSelecter:afterDelay: åï¼Œå®é™…ä¸Šå…¶å†…éƒ¨ä¼šåˆ›å»ºä¸€ä¸ª Timer å¹¶æ·»åŠ åˆ°å½“å‰çº¿ç¨‹çš„ RunLoop ä¸­ã€‚æ‰€ä»¥å¦‚æœå½“å‰çº¿ç¨‹æ²¡æœ‰ RunLoopï¼Œåˆ™è¿™ä¸ªæ–¹æ³•ä¼šå¤±æ•ˆã€‚</p>
<p>å½“è°ƒç”¨ performSelector:onThread: æ—¶ï¼Œå®é™…ä¸Šå…¶ä¼šåˆ›å»ºä¸€ä¸ª Timer åŠ åˆ°å¯¹åº”çš„çº¿ç¨‹å»ï¼ŒåŒæ ·çš„ï¼Œå¦‚æœå¯¹åº”çº¿ç¨‹æ²¡æœ‰ RunLoop è¯¥æ–¹æ³•ä¹Ÿä¼šå¤±æ•ˆã€‚</p>
</blockquote>
<p>åŸºæœ¬ä¹Ÿå°±å·®ä¸å¤šäº†ã€‚</p>
<hr>
<p>è€å¸æœºå†™è¿™ç¯‡åšå®¢å‘¢ï¼Œ<code>ä¹Ÿæ˜¯åº”ç›†å‹çš„è¦æ±‚å†™çš„</code>ï¼ŒåŸºæœ¬ä¸Šä¹Ÿæ˜¯é’ˆ<code>å¯¹å‰äººåšå®¢çš„æ€»ç»“</code>ä»¥åŠ<code>è‡ªå·±å¯¹æºç çš„è§£è¯»</code>ã€‚<strong>æ¯•ç«Ÿæœ‰äº†æºç ä»¥årunLoopä¹Ÿå°±æ²¡æœ‰é‚£ä¹ˆç¥ç§˜äº†</strong>ã€‚åªæ˜¯å¸Œæœ›å¤§å®¶æ˜ç™½<strong>runLoopå¹¶ä¸æ˜¯ä»€ä¹ˆå¤šä¹ˆå¯æ€•çš„ä¸œè¥¿</strong>ï¼Œåªè¦æˆ‘ä»¬ä¸€ç‚¹ä¸€ç‚¹å»çœ‹ï¼Œä»–<strong>ä¹Ÿæ˜¯äººå†™çš„ä»£ç å•Š</strong>=ã€‚=ä¸è¿‡è€å¸æœºæ‡’åˆ°è¿ä¼ªä»£ç éƒ½æ²¡ç»™ä½ ä»¬å†™ç›´æ¥ä¸Šçš„æºç ã€‚<code>åŸè°…ä¸€ä¸ªæ‡’ç™Œæ™šæœŸçš„äººå§</code>ã€‚</p>
<p>è¿˜æ˜¯è¦æ„Ÿè°¢ä¸¤ä½å¤§ç¥<strong>éƒ­è€€æº</strong>å’Œ<strong>å­™æº</strong>ä¸¤ä½å¤§ç¥ä¹‹å‰çš„åšå®¢å’Œè§†é¢‘è®²è§£è®©æˆ‘å¾ˆå—ç”¨ã€‚å¤§ç¥åé‡Œéƒ½å¸¦æºå­—ï¼Œæˆ‘è¦ä¸è¦æ”¹æˆ<code>è€æº</code>=ã€‚=</p>
<hr>
<p>å‚è€ƒèµ„æ–™ï¼š</p>
<ul>
<li><a href="http://blog.ibireme.com/2015/05/18/runloop/" target="_blank" rel="external">æ·±å…¥ç†è§£RunLoop
</a></li>
<li><a href="https://pan.baidu.com/s/1dFIfLAD" target="_blank" rel="external">å­™æºrunLoopçº¿ä¸‹åˆ†äº«ä¼šè§†é¢‘</a></li>
<li><a href="http://blog.csdn.net/ssirreplaceable/article/details/53793456" target="_blank" rel="external">å…³äºRunLoopéƒ¨åˆ†æºç çš„æ³¨é‡Š</a></li>
<li><a href="http://opensource.apple.com/tarballs/CF/CF-855.17.tar.gz" target="_blank" rel="external">CFRunLoopçš„æºç </a></li>
</ul>
<p>å¦å¤–ä½ å¦‚æœæƒ³çœ‹å­™æºçš„è§†é¢‘ï¼Œè€å¸æœºå·²ç»ç»™äº†ä¸‹è½½é“¾æ¥ï¼Œç„¶åä»<strong>æœ€å¼€å§‹åˆ°1å°æ—¶10åˆ†é’Ÿ</strong>çš„æ—¶å€™éƒ½æ˜¯å¹²è´§ï¼Œåé¢35åˆ†é’Ÿåè®¨è®ºï¼Œæ—¶é—´ç´§çš„ç«¥é´å¯ä»¥è·³è¿‡ï¼Œä½†æ˜¯åé¢ä¹Ÿæœ‰å¾ˆå¥½çš„æ€è·¯åˆ†äº«ï¼Œå¬å¬ä¹Ÿæ˜¯ä¸é”™çš„ã€‚</p>
<p>å¦‚æœä½ æƒ³çœ‹runLoopæºç ï¼Œå› ä¸ºæºç é‡Œé¢æœ‰4000å¤šè¡Œï¼Œè€å¸æœºè¯»æºç çš„æ—¶å€™è®²æœ‰ç”¨çš„æ–¹æ³•çš„è¡Œæ•°éƒ½è®°äº†ä¸‹æ¥ï¼Œä½ å¯ä»¥å¯¹åº”çš„æ‰¾ä¸€ä¸‹ï¼š</p>
<table>
<thead>
<tr>
<th style="text-align:center">æ–¹æ³•å</th>
<th style="text-align:center">è¡Œæ•°</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">__CFRunLoopFindMode</td>
<td style="text-align:center">#754</td>
</tr>
<tr>
<td style="text-align:center">__CFRunLoopCreate</td>
<td style="text-align:center">#1321</td>
</tr>
<tr>
<td style="text-align:center">_CFRunLoopGet0</td>
<td style="text-align:center">#1358</td>
</tr>
<tr>
<td style="text-align:center">__CFRunLoopAddItemToCommonModes</td>
<td style="text-align:center">#1536</td>
</tr>
<tr>
<td style="text-align:center">__CFRunLoopDoObservers</td>
<td style="text-align:center">#1668</td>
</tr>
<tr>
<td style="text-align:center">__CFRunLoopDoSources0</td>
<td style="text-align:center">#1764</td>
</tr>
<tr>
<td style="text-align:center">__CFRunLoopDoSource1</td>
<td style="text-align:center">#1829</td>
</tr>
<tr>
<td style="text-align:center">__CFRepositionTimerInMode</td>
<td style="text-align:center">#1999</td>
</tr>
<tr>
<td style="text-align:center">__CFRunLoopDoTimer</td>
<td style="text-align:center">#2024</td>
</tr>
<tr>
<td style="text-align:center">__CFRunLoopDoTimers</td>
<td style="text-align:center">#2152</td>
</tr>
<tr>
<td style="text-align:center">__CFRunLoopServiceMachPort</td>
<td style="text-align:center">#2196</td>
</tr>
<tr>
<td style="text-align:center">__CFRunLoopRun</td>
<td style="text-align:center">#2308</td>
</tr>
<tr>
<td style="text-align:center">CFRunLoopRunSpecific</td>
<td style="text-align:center">#2601</td>
</tr>
<tr>
<td style="text-align:center">CFRunLoopRun</td>
<td style="text-align:center">#2628</td>
</tr>
<tr>
<td style="text-align:center">CFRunLoopRunInMode</td>
<td style="text-align:center">#2636</td>
</tr>
<tr>
<td style="text-align:center">CFRunLoopWakeUp</td>
<td style="text-align:center">#2645</td>
</tr>
<tr>
<td style="text-align:center">CFRunLoopAddSource</td>
<td style="text-align:center">#2791</td>
</tr>
<tr>
<td style="text-align:center">CFRunLoopAddObserver</td>
<td style="text-align:center">#2978</td>
</tr>
<tr>
<td style="text-align:center">CFRunLoopAddTimer</td>
<td style="text-align:center">#3081</td>
</tr>
</tbody>
</table>
<p>æ‰“å®Œæ”¶åŠŸï¼<br><img src="http://upload-images.jianshu.io/upload_images/1835430-96b2100c0f20d96a.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="æ‰“å®Œæ”¶åŠŸ"></p>
<p>è€å¸æœºå†™è¿™ç¯‡åšå®¢çœŸçš„äº‹åºŸäº†å¾ˆå¤šå¿ƒè¡€çš„ï¼Œå¥½å°±ç»™èµå…³æ³¨å§~ä¹ˆä¹ˆå“’ğŸ˜˜~</p>
<p>æ— è€»çš„å¹¿å‘Šæ—¶é—´ï¼š</p>
<p>DWCoreTextLabelæ”¯æŒ<code>cocoaPods</code>äº†~<br><strong>pod search DWCoreTextLabel</strong></p>
<p><img src="http://upload-images.jianshu.io/upload_images/1835430-bc004dc959f7b675.gif?imageMogr2/auto-orient/strip" alt="DWCoreTextLabel"></p>
<p>æ’å…¥å›¾ç‰‡ã€ç»˜åˆ¶å›¾ç‰‡ã€æ·»åŠ äº‹ä»¶ç»Ÿç»Ÿä¸€å¥è¯å®ç°~</p>
<p><img src="http://upload-images.jianshu.io/upload_images/1835430-456beaed3f710b02.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="ä¸€å¥è¯å®ç°"></p>
<p>å°½å¯èƒ½ä¿æŒç³»ç»ŸLabelå±æ€§è®©ä½ å¯ä»¥æ— ç¼è¿‡æ¸¡ä½¿ç”¨~</p>
<p><img src="http://upload-images.jianshu.io/upload_images/1835430-e7706ffe827b1ea1.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="æ— ç¼è¿‡æ¸¡"></p>
<p>æ©ï¼Œè¯´äº†è¿™ä¹ˆå¤šï¼Œè€å¸æœºæ”¾ä¸€ä¸‹åœ°å€ï¼š<a href="https://github.com/CodeWicky/DWCoreTextLabel" target="_blank" rel="external">DWCoreTextLabel</a>ï¼Œå®å®ä»¬ç»™ä¸ªstarå§~çˆ±ä½ å“Ÿ~</p>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        
  <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
    <div>å„ä½åœŸè±ªå¤§ä½¬è§‰å¾—å¥½çš„è¯å¯ä»¥éšæ„æ‰“èµä¸‹~</div>
    <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
      <span>èµ</span>
    </button>
    <div id="QR" style="display: none;">
      
        <div id="wechat" style="display: inline-block">
          <img id="wechat_qr" src="http://or3w6eypz.bkt.clouddn.com/blogTheme/NexT/png/wxPay.jpeg" alt="CodeWicky WeChat Pay"/>
          <p>å¾®ä¿¡æ‰“èµ</p>
        </div>
      
      
        <div id="alipay" style="display: inline-block">
          <img id="alipay_qr" src="http://or3w6eypz.bkt.clouddn.com/blogTheme/NexT/png/aliPay.jpeg" alt="CodeWicky Alipay"/>
          <p>æ”¯ä»˜å®æ‰“èµ</p>
        </div>
      
    </div>
  </div>


      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/RunLoop/" rel="tag"># RunLoop</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/04/18/è€å¸æœºå‡ºå“â€”â€”â€”ç–¯ç‹‚é€ è½®å­ä¹‹æ»‘åŠ¨éªŒè¯ç /" rel="next" title="è€å¸æœºå‡ºå“â€”â€”â€”ç–¯ç‹‚é€ è½®å­ä¹‹æ»‘åŠ¨éªŒè¯ç ">
                <i class="fa fa-chevron-left"></i> è€å¸æœºå‡ºå“â€”â€”â€”ç–¯ç‹‚é€ è½®å­ä¹‹æ»‘åŠ¨éªŒè¯ç 
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/05/14/TableViewä¼˜åŒ–ä¹‹å¿«é€Ÿæ»‘åŠ¨ä¸‹çš„å¿½ç•¥åŠ è½½/" rel="prev" title="TableViewä¼˜åŒ–ä¹‹å¿«é€Ÿæ»‘åŠ¨ä¸‹çš„å¿½ç•¥åŠ è½½">
                TableViewä¼˜åŒ–ä¹‹å¿«é€Ÿæ»‘åŠ¨ä¸‹çš„å¿½ç•¥åŠ è½½ <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div id="SOHUCS"></div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            æ–‡ç« ç›®å½•
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            ç«™ç‚¹æ¦‚è§ˆ
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.png"
               alt="CodeWicky" />
          <p class="site-author-name" itemprop="name">CodeWicky</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
           
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">18</span>
                <span class="site-state-item-name">æ—¥å¿—</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">7</span>
                <span class="site-state-item-name">åˆ†ç±»</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">26</span>
                <span class="site-state-item-name">æ ‡ç­¾</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/CodeWicky" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://www.jianshu.com/u/a56ec10f6603" target="_blank" title="ç®€ä¹¦">
                  
                    <i class="fa fa-fw fa-user-circle"></i>
                  
                  ç®€ä¹¦
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="mailto:codewicky@163.com" target="_blank" title="E-Mail">
                  
                    <i class="fa fa-fw fa-envelope"></i>
                  
                  E-Mail
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#runLoopæ˜¯ä»€ä¹ˆ"><span class="nav-number">1.</span> <span class="nav-text">runLoopæ˜¯ä»€ä¹ˆ</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#runLoopæ˜¯å¦‚ä½•å®ç°çš„"><span class="nav-number">2.</span> <span class="nav-text">runLoopæ˜¯å¦‚ä½•å®ç°çš„</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#runLoopçš„ç»„æˆ"><span class="nav-number">2.1.</span> <span class="nav-text">runLoopçš„ç»„æˆ</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#pthread"><span class="nav-number">2.1.1.</span> <span class="nav-text">_pthread</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#modes"><span class="nav-number">2.1.2.</span> <span class="nav-text">_modes</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#runLoopä»£ç å®ç°"><span class="nav-number">2.2.</span> <span class="nav-text">runLoopä»£ç å®ç°</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#source0ï¼Œsource1"><span class="nav-number">2.2.1.</span> <span class="nav-text">source0ï¼Œsource1</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#NSTimeräº‹ä»¶æ˜¯å€ŸåŠ©runLoopå®ç°çš„ã€‚"><span class="nav-number">2.2.2.</span> <span class="nav-text">NSTimeräº‹ä»¶æ˜¯å€ŸåŠ©runLoopå®ç°çš„ã€‚</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#åŒä¸€æ—¶é—´å†…ï¼ŒrunLoopåªèƒ½è¿è¡ŒåŒä¸€ç§modeã€‚é‚£commonModeæ˜¯æ€ä¹ˆå®ç°çš„ï¼Ÿ"><span class="nav-number">2.2.3.</span> <span class="nav-text">åŒä¸€æ—¶é—´å†…ï¼ŒrunLoopåªèƒ½è¿è¡ŒåŒä¸€ç§modeã€‚é‚£commonModeæ˜¯æ€ä¹ˆå®ç°çš„ï¼Ÿ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#runLoopæ˜¯å¦‚ä½•ä¼‘çœ æœ‰å¦‚ä½•è¢«å”¤é†’çš„ï¼Ÿ"><span class="nav-number">2.2.4.</span> <span class="nav-text">runLoopæ˜¯å¦‚ä½•ä¼‘çœ æœ‰å¦‚ä½•è¢«å”¤é†’çš„ï¼Ÿ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#å¯ä»¥å”¤é†’runLoopçš„éƒ½æœ‰å“ªäº›äº‹ä»¶ï¼Ÿ"><span class="nav-number">2.2.5.</span> <span class="nav-text">å¯ä»¥å”¤é†’runLoopçš„éƒ½æœ‰å“ªäº›äº‹ä»¶ï¼Ÿ</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#runLoopéƒ½èƒ½åšä»€ä¹ˆ"><span class="nav-number">3.</span> <span class="nav-text">runLoopéƒ½èƒ½åšä»€ä¹ˆ</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#AutoReleasePoolï¼š"><span class="nav-number">3.1.</span> <span class="nav-text">AutoReleasePoolï¼š</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#CAAnimation"><span class="nav-number">3.2.</span> <span class="nav-text">CAAnimation</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#äº‹ä»¶å“åº”"><span class="nav-number">3.3.</span> <span class="nav-text">äº‹ä»¶å“åº”</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#æ‰‹åŠ¿è¯†åˆ«"><span class="nav-number">3.4.</span> <span class="nav-text">æ‰‹åŠ¿è¯†åˆ«</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#å®šæ—¶å™¨"><span class="nav-number">3.5.</span> <span class="nav-text">å®šæ—¶å™¨</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#PerformSelecter"><span class="nav-number">3.6.</span> <span class="nav-text">PerformSelecter</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">CodeWicky</span>
</div>


<div class="theme-info">
<p>Hosted by <a href="https://pages.coding.me" style="font-weight: bold">Coding Pages</a></p>
</div>


        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      
    </span>
  
</div>


        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>

  
  <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script>



  


  




	





  





  





  




  
    <script type="text/javascript">
    (function(){
      var appid = 'cyt3f8T5R';
      var conf = '5034be04c3b67fdcb8fbc7661b2c48bd';
      var width = window.innerWidth || document.documentElement.clientWidth;
      if (width < 960) {
      window.document.write('<script id="changyan_mobile_js" charset="utf-8" type="text/javascript" src="https://changyan.sohu.com/upload/mobile/wap-js/changyan_mobile.js?client_id=' + appid + '&conf=' + conf + '"><\/script>'); } else { var loadJs=function(d,a){var c=document.getElementsByTagName("head")[0]||document.head||document.documentElement;var b=document.createElement("script");b.setAttribute("type","text/javascript");b.setAttribute("charset","UTF-8");b.setAttribute("src",d);if(typeof a==="function"){if(window.attachEvent){b.onreadystatechange=function(){var e=b.readyState;if(e==="loaded"||e==="complete"){b.onreadystatechange=null;a()}}}else{b.onload=a}}c.appendChild(b)};loadJs("https://changyan.sohu.com/upload/changyan.js",function(){
        window.changyan.api.config({appid:appid,conf:conf})});
      }
    })();
    </script>
    <script type="text/javascript" src="https://assets.changyan.sohu.com/upload/plugins/plugins.count.js"></script>
  



  





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
  <script>AV.initialize("1IlPuOHFMSDCU3gbiqhOUE7m-gzGzoHsz", "11zBsvOWeJCGzXNguE7305pF");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  

  

  

</body>
</html>
